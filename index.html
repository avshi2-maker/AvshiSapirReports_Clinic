<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>×™×•××Ÿ ×¤×¨×•×™×§×˜×™× ××ª×§×“× - × ×™×”×•×œ ××©××‘×™× ×•×¢×œ×•×™×•×ª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            padding: max(20px, env(safe-area-inset-top)) max(20px, env(safe-area-inset-right)) max(20px, env(safe-area-inset-bottom)) max(20px, env(safe-area-inset-left));
            min-height: 100vh;
            -webkit-text-size-adjust: 100%;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
            word-break: break-word;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: #f5f5f5;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            position: relative;
            min-height: 44px;
        }

        .tab:hover {
            background: #e0e0e0;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab .remove-tab {
            margin-right: 8px;
            color: #ff4444;
            font-weight: bold;
            cursor: pointer;
        }

        .tab.active .remove-tab {
            color: #ffcccc;
        }

        .add-project-btn {
            padding: 12px 24px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            min-height: 44px;
        }

        .add-project-btn:hover {
            background: #45a049;
        }

        .project-content {
            display: none;
        }

        .project-content.active {
            display: block;
        }

        .section {
            background: #f9f9f9;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 2px solid #e0e0e0;
            overflow: visible;
        }

        .section-title {
            font-size: 1.5em;
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            word-break: break-word;
        }

        .resource-management {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .resource-list {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .resource-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 6px;
            margin-bottom: 8px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .resource-item input {
            width: 100px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }

        .resource-item button {
            padding: 8px 12px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            min-height: 44px;
            min-width: 44px;
        }

        .add-resource-form {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .add-resource-form input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            min-width: 120px;
        }

        .add-resource-form button {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            min-height: 44px;
            white-space: nowrap;
        }

        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .input-field {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        input, select, textarea {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            width: 100%;
            max-width: 100%;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* === Buttons area === */
        .buttons-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn {
            padding: 14px 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s;
            min-height: 44px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .email-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        /* === Tables â€” scrollable wrapper === */
        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            min-width: 700px;
        }

        th, td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid #e0e0e0;
            white-space: nowrap;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .delete-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            min-height: 44px;
            white-space: nowrap;
        }

        .delete-btn:hover {
            background: #cc0000;
        }

        .delete-row-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.4em;
            padding: 4px 8px;
            border-radius: 6px;
            transition: transform 0.2s, background 0.2s;
            min-height: 44px;
            min-width: 44px;
        }
        .delete-row-btn:hover {
            transform: scale(1.3);
            background: #ffe0e0;
        }

        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
            text-align: center;
        }

        .summary-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1em;
            word-break: break-word;
        }

        .summary-value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
            word-break: break-all;
        }

        .summary-label {
            color: #666;
            margin-top: 8px;
        }

        .financial-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-top: 30px;
            overflow: hidden;
        }

        .financial-summary h2 {
            text-align: center;
            margin-bottom: 25px;
            word-break: break-word;
        }

        .financial-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 20px;
        }

        .financial-item {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }

        .financial-item .label {
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .financial-item .value {
            font-size: 1.8em;
            font-weight: bold;
            word-break: break-all;
        }

        .net-profit {
            font-size: 2.2em !important;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .resource-select {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .resource-tag {
            padding: 8px 14px;
            background: #667eea;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            min-height: 44px;
            display: flex;
            align-items: center;
        }

        .resource-tag:hover {
            background: #764ba2;
        }

        .resource-tag.selected {
            background: #4CAF50;
        }

        /* === Auto-save bar === */
        .autosave-bar {
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f0f0f0;
            padding: 12px;
            border-radius: 8px;
            flex-wrap: wrap;
        }

        /* === Inline grid panels (recommendation, payment, etc.) === */
        .inline-grid-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }

        .inline-grid-cell {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }

        .inline-result-box {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            text-align: center;
        }

        /* === Payment form inside financial-summary === */
        .payment-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .payment-form input {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 16px;
        }

        .payment-form label {
            display: block;
            margin-bottom: 5px;
            color: white;
        }

        .payment-full-width {
            grid-column: 1 / -1;
        }

        .payment-add-btn {
            padding: 12px 20px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            font-size: 16px;
            min-height: 44px;
        }

        /* === Print Header/Footer per page === */
        .print-page-header {
            display: none;
        }
        .print-page-footer {
            display: none;
        }

        /* === Print === */
        @media print {
            @page {
                size: A4 portrait;
                margin: 15mm 12mm 18mm 12mm;
            }

            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            body {
                background: white !important;
                padding: 0 !important;
                font-size: 10pt;
            }

            .container {
                box-shadow: none !important;
                padding: 0 !important;
                border-radius: 0 !important;
                max-width: 100% !important;
            }

            /* Only show the active project content */
            .project-content {
                display: none !important;
            }
            .project-content.active {
                display: block !important;
            }

            /* Hide interactive elements */
            .btn, .delete-btn, .delete-row-btn, .tabs, .add-resource-form,
            .buttons-row, .autosave-bar, .add-project-btn, .calc-preview,
            .calc-btn, .resource-tag, .resource-select,
            .payment-add-btn, .payment-form,
            .add-resource-form button, .resource-item button,
            #reportHistoryTable .delete-btn,
            input[type="checkbox"],
            .remove-tab,
            .paid-resources-box {
                display: none !important;
            }

            /* Hide the report history section in print */
            .report-history-section {
                display: none !important;
            }

            /* Show print headers */
            .print-page-header {
                display: block !important;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                color: white !important;
                padding: 10px 20px !important;
                margin: 0 -5mm 12px -5mm !important;
                border-radius: 0 0 8px 8px !important;
                font-size: 11pt;
                font-weight: 700;
                text-align: center;
            }
            .print-page-header .print-header-title {
                font-size: 13pt;
                margin-bottom: 2px;
            }
            .print-page-header .print-header-sub {
                font-size: 9pt;
                opacity: 0.85;
            }

            /* Show print footers */
            .print-page-footer {
                display: block !important;
                text-align: center;
                font-size: 8pt;
                color: #999;
                border-top: 1px solid #ddd;
                padding-top: 6px;
                margin-top: auto;
                padding-bottom: 0;
            }

            /* Hide main title on all pages (it shows in headers) */
            h1, .subtitle {
                display: none !important;
            }

            /* ======= PAGE BREAKS ======= */
            /* Each .section is its own page */
            .project-content .section {
                break-before: page !important;
                page-break-before: always !important;
                border: none !important;
                padding: 0 !important;
                margin: 0 !important;
                background: white !important;
            }
            /* First section: no page break before */
            .project-content .section:first-of-type {
                break-before: auto !important;
                page-break-before: auto !important;
            }


            /* Grand total box - inside data table section, avoid page break */
            .grand-total-box {
                display: block !important;
                visibility: visible !important;
                break-before: avoid !important;
                page-break-before: avoid !important;
                break-inside: avoid !important;
                page-break-inside: avoid !important;
                margin-top: 15px !important;
                background: linear-gradient(135deg, #1a237e 0%, #4a148c 100%) !important;
                color: white !important;
                padding: 20px !important;
                border-radius: 10px !important;
                border: 2px solid gold !important;
            }

            /* Financial summary sections get their own page */
            .financial-summary {
                break-before: page !important;
                page-break-before: always !important;
            }

            /* Prevent breaks inside these elements */
            .summary-card, .financial-item, .grand-total-cell,
            .resource-item, .resource-detail-line, .inline-result-box {
                break-inside: avoid !important;
                page-break-inside: avoid !important;
            }

            .section {
                break-inside: auto !important;
                page-break-inside: auto !important;
            }

            /* ======= TABLE FIX FOR PRINT ======= */
            .table-wrapper {
                overflow: visible !important;
                width: 100% !important;
            }

            table {
                min-width: 0 !important;
                width: 100% !important;
                font-size: 7pt !important;
                table-layout: fixed !important;
            }

            th, td {
                white-space: normal !important;
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
                padding: 4px 3px !important;
                font-size: 7pt !important;
                line-height: 1.3 !important;
            }

            /* Column widths for data tables in print (17 cols including hidden delete) */
            table[id^="dataTable"] th:nth-child(1),
            table[id^="dataTable"] td:nth-child(1) { width: 3%; }  /* # */
            table[id^="dataTable"] th:nth-child(2),
            table[id^="dataTable"] td:nth-child(2) { width: 6%; }  /* ×ª××¨×™×š ×”×•×¡×¤×” */
            table[id^="dataTable"] th:nth-child(3),
            table[id^="dataTable"] td:nth-child(3) { width: 5%; }  /* ×ª××¨×™×š ×”×ª×—×œ×” */
            table[id^="dataTable"] th:nth-child(4),
            table[id^="dataTable"] td:nth-child(4) { width: 5%; }  /* ×ª××¨×™×š ×¡×™×•× */
            table[id^="dataTable"] th:nth-child(5),
            table[id^="dataTable"] td:nth-child(5) { width: 4%; }  /* ×™××™ ×¢×‘×•×“×” */
            table[id^="dataTable"] th:nth-child(6),
            table[id^="dataTable"] td:nth-child(6) { width: 4%; }  /* ×©×¢×•×ª */
            table[id^="dataTable"] th:nth-child(7),
            table[id^="dataTable"] td:nth-child(7) { width: 9%; }  /* × ×•×©× */
            table[id^="dataTable"] th:nth-child(8),
            table[id^="dataTable"] td:nth-child(8) { width: 9%; }  /* ××¨×›×™×‘ */
            table[id^="dataTable"] th:nth-child(9),
            table[id^="dataTable"] td:nth-child(9) { width: 7%; }  /* ××©××‘×™× */
            table[id^="dataTable"] th:nth-child(10),
            table[id^="dataTable"] td:nth-child(10) { width: 8%; }  /* ×”×¢×¨×•×ª */
            table[id^="dataTable"] th:nth-child(11),
            table[id^="dataTable"] td:nth-child(11) { width: 6%; }  /* ×¢×œ×•×ª ××©××‘×™× */
            table[id^="dataTable"] th:nth-child(12),
            table[id^="dataTable"] td:nth-child(12) { width: 5%; }  /* ××©××‘×™× ×©×©×•×œ××• */
            table[id^="dataTable"] th:nth-child(13),
            table[id^="dataTable"] td:nth-child(13) { width: 6%; }  /* ×—×™×•×‘ ×¢×‘×•×“×” */
            table[id^="dataTable"] th:nth-child(14),
            table[id^="dataTable"] td:nth-child(14) { width: 4%; }  /* ×”× ×—×” */
            table[id^="dataTable"] th:nth-child(15),
            table[id^="dataTable"] td:nth-child(15) { width: 6%; }  /* ×—×™×•×‘ ××—×¨×™ ×”× ×—×” */
            table[id^="dataTable"] th:nth-child(16),
            table[id^="dataTable"] td:nth-child(16) { width: 7%; }  /* ×¡×”"×› ×¨×©×•××” */
            /* Hide delete column in print */
            table th:last-child,
            table td:last-child {
                display: none !important;
            }

            th {
                background: #667eea !important;
                color: white !important;
                font-weight: 700 !important;
                font-size: 6.5pt !important;
            }

            /* ======= SUMMARY CARDS PRINT ======= */
            .summary {
                gap: 10px !important;
                margin-top: 15px !important;
            }
            .summary-card {
                padding: 10px !important;
                border: 1px solid #ccc !important;
            }
            .summary-card h3 {
                font-size: 8pt !important;
            }
            .summary-value {
                font-size: 14pt !important;
            }

            /* ======= GRAND TOTAL BOX PRINT ======= */
            .grand-total-box {
                background: linear-gradient(135deg, #1a237e 0%, #4a148c 100%) !important;
                color: white !important;
                padding: 20px !important;
                border-radius: 10px !important;
                border: 2px solid gold !important;
            }
            .grand-total-box h2 {
                font-size: 14pt !important;
                margin-bottom: 15px !important;
            }
            .grand-total-grid {
                gap: 10px !important;
            }
            .grand-total-cell {
                background: rgba(255,255,255,0.12) !important;
                padding: 12px !important;
            }
            .grand-total-cell .gt-label {
                font-size: 8pt !important;
            }
            .grand-total-cell .gt-value {
                font-size: 14pt !important;
            }
            .grand-total-final {
                background: gold !important;
                color: #1a237e !important;
                padding: 15px !important;
                font-size: 16pt !important;
                margin-top: 10px !important;
            }

            /* ======= FINANCIAL SUMMARY PRINT ======= */
            .financial-summary {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                color: white !important;
                padding: 20px !important;
                border-radius: 10px !important;
            }
            .financial-summary h2 {
                font-size: 13pt !important;
            }
            .financial-grid {
                gap: 10px !important;
            }
            .financial-item {
                background: rgba(255,255,255,0.1) !important;
                padding: 10px !important;
            }
            .financial-item .value {
                font-size: 12pt !important;
            }
            .net-profit {
                font-size: 14pt !important;
            }
            .inline-result-box {
                background: rgba(255,255,255,0.15) !important;
                padding: 12px !important;
                margin-top: 10px !important;
            }

            /* ======= SECTION HEADINGS PRINT ======= */
            .section-title {
                font-size: 13pt !important;
                color: #667eea !important;
                border-bottom: 2px solid #667eea;
                padding-bottom: 8px;
                margin-bottom: 12px !important;
            }

            /* Allow content to overflow across pages */
            .section {
                overflow: visible !important;
            }

            /* Make sure table rows can break to next page */
            table {
                break-inside: auto !important;
                page-break-inside: auto !important;
            }
            thead {
                display: table-header-group !important;
            }
            tr {
                break-inside: avoid !important;
                page-break-inside: avoid !important;
            }

            /* Summary section after data table (inside same .section) */
            .summary {
                margin-top: 15px !important;
                gap: 8px !important;
                display: grid !important;
                visibility: visible !important;
            }

            /* ======= INPUT FIELDS PRINT ======= */
            .input-group {
                gap: 8px !important;
            }
            input, select, textarea {
                border: 1px solid #ccc !important;
                padding: 6px !important;
                font-size: 9pt !important;
            }
            label {
                font-size: 9pt !important;
            }

            /* ======= RESOURCE LISTS PRINT ======= */
            .resource-management {
                grid-template-columns: 1fr !important;
            }
            .resource-list {
                padding: 10px !important;
            }
            .resource-item {
                padding: 6px 8px !important;
                font-size: 9pt !important;
            }
            .resource-item input {
                border: 1px solid #ccc !important;
                padding: 3px 5px !important;
                font-size: 9pt !important;
            }

            /* ======= PAYMENT RECORDS PRINT ======= */
            .payment-section {
                break-inside: avoid !important;
                page-break-inside: avoid !important;
            }
        }

        /* ========================================
           RESPONSIVE â€” TABLET (max-width: 768px)
           ======================================== */
        @media screen and (max-width: 768px) {
            body {
                padding: 8px;
            }

            .container {
                padding: 16px;
                border-radius: 12px;
            }

            h1 {
                font-size: 1.6em;
            }

            .subtitle {
                font-size: 0.95em;
                margin-bottom: 20px;
            }

            .tabs {
                gap: 6px;
                margin-bottom: 20px;
            }

            .tab {
                padding: 10px 14px;
                font-size: 14px;
            }

            .add-project-btn {
                padding: 10px 14px;
                font-size: 14px;
                width: 100%;
                text-align: center;
            }

            .section {
                padding: 14px;
                margin-bottom: 16px;
            }

            .section-title {
                font-size: 1.15em;
            }

            .resource-management {
                grid-template-columns: 1fr;
            }

            .resource-list {
                padding: 12px;
            }

            .resource-item {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .resource-item input {
                width: 100%;
            }

            .add-resource-form {
                flex-direction: column;
            }

            .add-resource-form input {
                min-width: 100%;
            }

            .add-resource-form button {
                width: 100%;
            }

            .input-group {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            /* Buttons stack on mobile */
            .buttons-row .btn,
            .btn {
                width: 100%;
                text-align: center;
                padding: 12px 16px;
                font-size: 15px;
                margin-bottom: 0;
            }

            /* Tables scroll horizontally */
            .table-wrapper {
                margin-left: -14px;
                margin-right: -14px;
                padding-left: 14px;
                padding-right: 14px;
            }

            table {
                min-width: 600px;
            }

            th, td {
                padding: 10px 8px;
                font-size: 13px;
            }

            .summary {
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }

            .summary-card {
                padding: 14px;
            }

            .summary-card h3 {
                font-size: 0.85em;
            }

            .summary-value {
                font-size: 1.5em;
            }

            .financial-summary {
                padding: 18px;
                margin-top: 20px;
            }

            .financial-summary h2 {
                font-size: 1.2em;
                margin-bottom: 18px;
            }

            .financial-grid {
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }

            .financial-item {
                padding: 10px;
            }

            .financial-item .value {
                font-size: 1.3em;
            }

            .net-profit {
                font-size: 1.5em !important;
            }

            .inline-grid-panel {
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }

            .inline-result-box {
                padding: 14px;
            }

            .inline-result-box [style*="font-size: 2.5em"] {
                font-size: 1.6em !important;
            }

            .payment-form {
                grid-template-columns: 1fr;
            }

            .autosave-bar {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        /* ========================================
           RESPONSIVE â€” PHONE (max-width: 480px)
           ======================================== */
        @media screen and (max-width: 480px) {
            body {
                padding: 4px;
            }

            .container {
                padding: 10px;
                border-radius: 10px;
            }

            h1 {
                font-size: 1.3em;
            }

            .subtitle {
                font-size: 0.85em;
            }

            .tab {
                padding: 8px 10px;
                font-size: 13px;
            }

            .section {
                padding: 10px;
            }

            .section-title {
                font-size: 1em;
            }

            .summary {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .summary-value {
                font-size: 1.3em;
            }

            .financial-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .financial-item .value {
                font-size: 1.1em;
            }

            .net-profit {
                font-size: 1.3em !important;
            }

            .inline-grid-panel {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            th, td {
                padding: 8px 6px;
                font-size: 12px;
            }
        }

        /* === Calculation Preview Box === */
        .calc-preview {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 3px solid #4CAF50;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }
        .calc-preview.visible { display: block; }
        .calc-preview h3 { color: #2e7d32; margin-bottom: 15px; text-align: center; font-size: 1.3em; }
        .calc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }
        .calc-cell {
            background: white;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #a5d6a7;
        }
        .calc-cell .calc-label { font-size: 0.85em; color: #555; margin-bottom: 6px; }
        .calc-cell .calc-value { font-size: 1.5em; font-weight: 800; color: #2e7d32; }
        .calc-total-row {
            background: #2e7d32;
            color: white;
            padding: 18px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.6em;
            font-weight: 800;
        }
        .calc-btn {
            padding: 14px 28px;
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            min-height: 44px;
            transition: transform 0.2s;
        }
        .calc-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255,152,0,0.4); }
        /* === Grand Total Box === */
        .grand-total-box {
            background: linear-gradient(135deg, #1a237e 0%, #4a148c 100%);
            color: white;
            padding: 30px;
            border-radius: 16px;
            margin-top: 30px;
            border: 3px solid gold;
        }
        .grand-total-box h2 { text-align: center; margin-bottom: 20px; font-size: 1.6em; }
        .grand-total-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .grand-total-cell {
            background: rgba(255,255,255,0.12);
            padding: 18px;
            border-radius: 10px;
            text-align: center;
        }
        .grand-total-cell .gt-label { font-size: 0.9em; margin-bottom: 8px; opacity: 0.9; }
        .grand-total-cell .gt-value { font-size: 2em; font-weight: 800; }
        .grand-total-final {
            background: gold;
            color: #1a237e;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-size: 2.2em;
            font-weight: 900;
        }
        .record-num { 
            display: inline-block;
            background: #667eea;
            color: white;
            width: 28px; height: 28px;
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            font-weight: bold;
            font-size: 0.85em;
        }
        /* Discount row */
        .discount-row {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border: 2px solid #ff9800;
            border-radius: 10px;
            padding: 15px 20px;
            margin: 12px 0;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .discount-row label { font-weight: 700; color: #e65100; margin: 0; white-space: nowrap; }
        .discount-input {
            width: 80px !important;
            padding: 8px 10px !important;
            border: 2px solid #ff9800 !important;
            border-radius: 8px !important;
            font-size: 1.1em !important;
            font-weight: 700;
            text-align: center;
            background: white;
        }
        .discount-result {
            flex: 1;
            min-width: 200px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .discount-chip {
            background: white;
            border: 2px solid #ff9800;
            border-radius: 8px;
            padding: 8px 14px;
            text-align: center;
        }
        .discount-chip .dc-label { font-size: 0.8em; color: #e65100; }
        .discount-chip .dc-value { font-size: 1.2em; font-weight: 800; color: #bf360c; }
        .discount-chip.after-discount { border-color: #4CAF50; }
        .discount-chip.after-discount .dc-label { color: #2e7d32; }
        .discount-chip.after-discount .dc-value { color: #2e7d32; }
        /* Resource detail box */
        .resource-detail-box {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 2px solid #1976d2;
            border-radius: 10px;
            padding: 15px 20px;
            margin: 12px 0;
        }
        .resource-detail-box h4 { color: #0d47a1; margin-bottom: 10px; }
        .resource-detail-line {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            margin-bottom: 6px;
            font-weight: 600;
        }
        .resource-detail-line .rd-name { color: #1565c0; }
        .resource-detail-line .rd-calc { color: #555; font-size: 0.9em; }
        .resource-detail-line .rd-total { color: #0d47a1; font-weight: 800; }
        .resource-detail-total {
            display: flex;
            justify-content: space-between;
            padding: 10px 12px;
            background: #1565c0;
            color: white;
            border-radius: 6px;
            font-weight: 800;
            font-size: 1.1em;
        }
        /* Paid Resources Section */
        .paid-resources-box {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 2px solid #4CAF50;
            border-radius: 10px;
            padding: 15px 20px;
            margin: 15px 0;
        }
        .paid-resources-box h4 { color: #2e7d32; margin-bottom: 12px; font-size: 1.1em; }
        .paid-resources-inputs {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        .paid-resources-inputs .input-field {
            flex: 1;
            min-width: 160px;
        }
        .paid-resources-inputs label {
            color: #2e7d32;
            font-weight: 700;
            font-size: 0.9em;
        }
        .paid-resources-inputs input {
            border: 2px solid #4CAF50 !important;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š ×™×•××Ÿ ×¤×¨×•×™×§×˜×™× ××ª×§×“×</h1>
        <p class="subtitle">× ×™×”×•×œ ××©××‘×™×, ×¢×œ×•×™×•×ª ×•×¤×¨×•×™×§×˜×™× ××¨×•×‘×™×</p>

        <!-- Tabs for projects -->
        <div class="tabs" id="projectTabs">
            <button class="tab active" data-project="0">
                ×¤×¨×•×™×§×˜ ×¨××©×™
            </button>
            <button class="add-project-btn" onclick="addNewProject()">â• ×¤×¨×•×™×§×˜ ×—×“×©</button>
        </div>

        <!-- Project 0 Content (Default) -->
        <div class="project-content active" id="project-0">
            
            <!-- Resource Management Section -->
            <div class="section">
                <h2 class="section-title">âš™ï¸ × ×™×”×•×œ ××©××‘×™×</h2>
                <div class="resource-management">
                    <div class="resource-list">
                        <h3>×¨×©×™××ª ××©××‘×™× ×–××™× ×™×</h3>
                        <div id="resourceList-0"></div>
                        <div class="add-resource-form">
                            <input type="text" id="newResourceName-0" placeholder="×©× ×”××©××‘">
                            <input type="number" id="newResourceCost-0" placeholder="×¢×œ×•×ª ×™×•××™×ª (â‚ª)" step="0.01">
                            <button onclick="addResource(0)">â• ×”×•×¡×£ ××©××‘</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Entry Form -->
            <div class="section">
                <h2 class="section-title">âœï¸ ×”×•×¡×¤×ª ×¨×©×•××” ×—×“×©×” â€” ××‘×©×™ ×¡×¤×™×¨, ××¤×ª×— ××ª×—×™×œ</h2>
                <div class="input-group">
                    <div class="input-field">
                        <label>×ª××¨×™×š ×”×ª×—×œ×”:</label>
                        <input type="date" id="startDate-0">
                    </div>
                    <div class="input-field">
                        <label>×ª××¨×™×š ×¡×™×•×:</label>
                        <input type="date" id="endDate-0">
                    </div>
                    <div class="input-field">
                        <label>× ×•×©× ×›×œ×œ×™:</label>
                        <input type="text" id="topic-0" placeholder="×ª×™××•×¨ ×”× ×•×©×">
                    </div>
                    <div class="input-field">
                        <label>××¨×›×™×‘ ×©× ×‘× ×”:</label>
                        <input type="text" id="component-0" placeholder="××” × ×‘× ×”?">
                    </div>
                    <div class="input-field">
                        <label>×©×¢×•×ª ×¢×‘×•×“×” ×‘×™×•×:</label>
                        <input type="number" id="hours-0" value="10" min="0" step="0.5">
                    </div>
                    <div class="input-field">
                        <label>×—×™×•×‘ ×©×¢×ª×™ ×œ××¤×ª×— ×¢× × ×™×¡×™×•×Ÿ (â‚ª):</label>
                        <input type="number" id="hourlyRate-0" value="0" min="0" step="1">
                    </div>
                    <div class="input-field">
                        <label>ğŸ“ ×”× ×—×ª ××ª×œ××“ (%):</label>
                        <input type="number" id="discountEntry-0" value="35" min="0" max="100" step="1">
                        <small style="color: #e65100;">××•××œ×¥: 35% ×œ××¤×ª×— ×—×“×© ×¢× ×›×œ×™ AI</small>
                    </div>
                </div>
                
                <div class="input-field">
                    <label>×‘×—×¨ ××©××‘×™× ×©××‘×©×™ ×¡×¤×™×¨ ×”××¤×ª×— ×”×©×ª××© ×•×©×™×œ× ×‘×××¦×¢×•×ª ×›×¨×˜×™×¡ ×”××©×¨××™ ×”×¤×¨×˜×™:</label>
                    <div class="resource-select" id="resourceSelect-0"></div>
                </div>

                <!-- Paid Resources Section - PROJECT LEVEL (saves immediately) -->
                <div class="paid-resources-box" id="paidResourcesBox-0">
                    <h4>ğŸ’³ ××©××‘×™× ×©×©×•×œ××• â€” ×¡×›×•× ×©×©×•×œ× ×¢"×™ ×”×™×–× ×¨×•× ×™ ×¡×¤×™×¨</h4>
                    <div class="paid-resources-inputs">
                        <div class="input-field">
                            <label>×¡×›×•× ×©×©×•×œ× (â‚ª):</label>
                            <input type="number" id="paidResourcesAmount-0" value="0" min="0" step="0.01" placeholder="×¡×›×•× ×©×©×•×œ×"
                                oninput="savePaidResources(0)">
                        </div>
                        <div class="input-field">
                            <label>×ª××¨×™×š ×ª×©×œ×•×:</label>
                            <input type="date" id="paidResourcesDate-0"
                                onchange="savePaidResources(0)">
                        </div>
                    </div>
                    <div id="paidResourcesStatus-0" style="text-align:center; margin-top:8px; font-size:0.85em; color:#2e7d32; font-weight:600;"></div>
                </div>

                <div class="input-field">
                    <label>×”×¢×¨×•×ª:</label>
                    <textarea id="notes-0" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª ×¢×œ ×”×¨×©×•××”..."></textarea>
                </div>

                <!-- Calculation Preview -->
                <div class="calc-preview" id="calcPreview-0">
                    <h3>ğŸ”¢ ×ª×¦×•×’×” ××§×“×™××” ×©×œ ×—×™×©×•×‘</h3>
                    <div class="calc-grid">
                        <div class="calc-cell">
                            <div class="calc-label">ğŸ“… ×™××™ ×¢×‘×•×“×”</div>
                            <div class="calc-value" id="prevDays-0">0</div>
                        </div>
                        <div class="calc-cell">
                            <div class="calc-label">â° ×¡×”"×› ×©×¢×•×ª</div>
                            <div class="calc-value" id="prevHours-0">0</div>
                        </div>
                        <div class="calc-cell">
                            <div class="calc-label">ğŸ’µ ×—×™×•×‘ ×©×¢×ª×™ ×œ××¤×ª×— ×¢× × ×™×¡×™×•×Ÿ</div>
                            <div class="calc-value" id="prevRate-0">0 â‚ª</div>
                        </div>
                        <div class="calc-cell">
                            <div class="calc-label">ğŸ’° ×—×™×•×‘ ×¢×‘×•×“×” (×œ×¤× ×™ ×”× ×—×”)</div>
                            <div class="calc-value" id="prevWorkCost-0">0 â‚ª</div>
                        </div>
                    </div>
                    
                    <!-- Discount Row -->
                    <div class="discount-row">
                        <label>ğŸ“ ×”× ×—×ª ××ª×œ××“:</label>
                        <input type="number" class="discount-input" id="discountPct-0" value="35" min="0" max="100" step="1" oninput="previewCalculation(0)">
                        <span style="font-weight:700; color:#e65100;">%</span>
                        <div class="discount-result">
                            <div class="discount-chip">
                                <div class="dc-label">ğŸ’¸ ×¡×›×•× ×”× ×—×”</div>
                                <div class="dc-value" id="prevDiscountAmt-0">0 â‚ª</div>
                            </div>
                            <div class="discount-chip after-discount">
                                <div class="dc-label">âœ… ×—×™×•×‘ ×¢×‘×•×“×” ××—×¨×™ ×”× ×—×”</div>
                                <div class="dc-value" id="prevWorkAfterDiscount-0">0 â‚ª</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Resource Detail Box -->
                    <div class="resource-detail-box" id="prevResourceBox-0">
                        <h4>âš™ï¸ ×¤×™×¨×•×˜ ×¢×œ×•×™×•×ª ××©××‘×™×</h4>
                        <div id="prevResourceLines-0">
                            <div style="color:#999; padding: 10px; text-align:center;">×œ× × ×‘×—×¨×• ××©××‘×™×</div>
                        </div>
                    </div>

                    <!-- Paid Resources Preview -->
                    <div class="discount-row" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-color: #4CAF50;">
                        <label style="color: #2e7d32;">ğŸ’³ ××©××‘×™× ×©×©×•×œ××•:</label>
                        <div class="discount-result">
                            <div class="discount-chip" style="border-color: #4CAF50;">
                                <div class="dc-label" style="color: #2e7d32;">ğŸ’³ ×¡×›×•× ×©×©×•×œ×</div>
                                <div class="dc-value" style="color: #2e7d32;" id="prevPaidResources-0">0 â‚ª</div>
                            </div>
                            <div class="discount-chip" style="border-color: #4CAF50;">
                                <div class="dc-label" style="color: #2e7d32;">ğŸ“… ×ª××¨×™×š ×ª×©×œ×•×</div>
                                <div class="dc-value" style="color: #2e7d32;" id="prevPaidDate-0">-</div>
                            </div>
                            <div class="discount-chip after-discount">
                                <div class="dc-label">âš™ï¸ ×¢×œ×•×ª ××©××‘×™× × ×˜×•</div>
                                <div class="dc-value" id="prevNetResourceCost-0">0 â‚ª</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="calc-total-row">
                        ×¡×”"×› ×œ×¨×©×•××” (×¢×‘×•×“×” + ××©××‘×™× - ×©×©×•×œ××•): <span id="prevTotal-0">0</span> â‚ª
                    </div>
                </div>

                <div class="buttons-row">
                    <button class="calc-btn" onclick="previewCalculation(0)">ğŸ”¢ ×—×©×‘ ×¡×”"×›</button>
                    <button class="btn" onclick="addEntry(0)">â• ×”×•×¡×£ ×¨×©×•××”</button>
                    <button class="btn email-btn" onclick="sendEmail(0)">ğŸ“§ ×©×œ×— ×‘××™×™×œ</button>
                    <button class="btn" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);" onclick="printProject(0)">ğŸ–¨ï¸ ×”×“×¤×¡×”</button>
                    <button class="btn" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);" onclick="createShareableLink(0)">ğŸ”— ×¦×•×¨ ×§×™×©×•×¨</button>
                    <button class="btn" style="background: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%);" onclick="shareToWhatsApp(0)">ğŸ“± ×©×ª×£ ×‘×•×•×˜×¡××¤</button>
                    <button class="btn" style="background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);" onclick="manualSave(0)">ğŸ’¾ ×©××™×¨×” ×™×“× ×™×ª</button>
                    <button class="btn" style="background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);" onclick="exportForNotebookLM(0)">ğŸ““ ×™×™×¦×•× ×œâ€‘NotebookLM (.md)</button>
                </div>
                
                <div class="autosave-bar">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin: 0;">
                        <input type="checkbox" id="autoSaveToggle-0" onchange="toggleAutoSave(0)" style="width: 20px; height: 20px; cursor: pointer;">
                        <span style="font-weight: 600;">ğŸ”„ ×©××™×¨×” ××•×˜×•××˜×™×ª (×›×œ 60 ×©× ×™×•×ª)</span>
                    </label>
                    <span id="autoSaveStatus-0" style="color: #666; font-size: 0.9em;"></span>
                </div>
            </div>

            <!-- Data Table + Summary + Grand Total (all in one section) -->
            <div class="section" id="dataTableSection-0">
                <h2 class="section-title">ğŸ“‹ ×˜×‘×œ×ª × ×ª×•× ×™×</h2>
                <div class="table-wrapper">
                    <table id="dataTable-0">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>×ª××¨×™×š ×”×•×¡×¤×”</th>
                                <th>×ª××¨×™×š ×”×ª×—×œ×”</th>
                                <th>×ª××¨×™×š ×¡×™×•×</th>
                                <th>×™××™ ×¢×‘×•×“×”</th>
                                <th>×¡×”"×› ×©×¢×•×ª</th>
                                <th>× ×•×©× ×›×œ×œ×™</th>
                                <th>××¨×›×™×‘ ×©× ×‘× ×”</th>
                                <th>××©××‘×™×</th>
                                <th>×”×¢×¨×•×ª</th>
                                <th>×¢×œ×•×ª ××©××‘×™× (â‚ª)</th>
                                <th style="background: #2e7d32 !important; color: white;">××©××‘×™× ×©×©×•×œ××• (â‚ª)</th>
                                <th>×—×™×•×‘ ×¢×‘×•×“×” (â‚ª)</th>
                                <th>×”× ×—×” %</th>
                                <th>×—×™×•×‘ ××—×¨×™ ×”× ×—×” (â‚ª)</th>
                                <th>×¡×”"×› ×¨×©×•××” (â‚ª)</th>
                                <th>×¤×¢×•×œ×•×ª</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- Summary Cards -->
                <div class="summary" id="summary-0">
                    <div class="summary-card">
                        <h3>ğŸ“… ×¡×”"×› ×™××™ ×¢×‘×•×“×”</h3>
                        <div class="summary-value" id="totalDays-0">0</div>
                        <div class="summary-label">×™××™×</div>
                    </div>
                    <div class="summary-card">
                        <h3>â° ×¡×”"×› ×©×¢×•×ª ×¢×‘×•×“×”</h3>
                        <div class="summary-value" id="totalHours-0">0</div>
                        <div class="summary-label">×©×¢×•×ª</div>
                    </div>
                    <div class="summary-card">
                        <h3>ğŸ’¸ ×¡×”"×› ×¢×œ×•×ª ××©××‘×™×</h3>
                        <div class="summary-value" id="totalResourceCost-0">0</div>
                        <div class="summary-label">â‚ª</div>
                    </div>
                    <div class="summary-card" style="border: 2px solid #4CAF50;">
                        <h3>ğŸ’³ ×¡×”"×› ××©××‘×™× ×©×©×•×œ××•</h3>
                        <div class="summary-value" style="color: #2e7d32;" id="totalPaidResources-0">0</div>
                        <div class="summary-label">â‚ª</div>
                    </div>
                    <div class="summary-card">
                        <h3>ğŸ’° ×¡×”"×› ×œ×ª×©×œ×•×</h3>
                        <div class="summary-value" id="totalIncome-0">0</div>
                        <div class="summary-label">â‚ª</div>
                    </div>
                </div>

                <!-- Grand Total Summary -->
                <div class="grand-total-box" id="grandTotal-0">
                    <h2>ğŸ† ×¡×™×›×•× ×›×•×œ×œ - ×›×œ ×”×¨×©×•××•×ª</h2>
                    <div class="grand-total-grid">
                        <div class="grand-total-cell">
                            <div class="gt-label">ğŸ“‹ ××¡×¤×¨ ×¨×©×•××•×ª</div>
                            <div class="gt-value" id="gtRecords-0">0</div>
                        </div>
                        <div class="grand-total-cell">
                            <div class="gt-label">ğŸ“… ×¡×”"×› ×™××™ ×¢×‘×•×“×”</div>
                            <div class="gt-value" id="gtDays-0">0</div>
                        </div>
                        <div class="grand-total-cell">
                            <div class="gt-label">â° ×¡×”"×› ×©×¢×•×ª</div>
                            <div class="gt-value" id="gtHours-0">0</div>
                        </div>
                        <div class="grand-total-cell">
                            <div class="gt-label">ğŸ’° ×—×™×•×‘ ×¢×‘×•×“×”</div>
                            <div class="gt-value" id="gtWorkCharge-0">0 â‚ª</div>
                        </div>
                        <div class="grand-total-cell">
                            <div class="gt-label">âš™ï¸ ×¢×œ×•×ª ××©××‘×™×</div>
                            <div class="gt-value" id="gtResourceCost-0">0 â‚ª</div>
                        </div>
                        <div class="grand-total-cell" style="background: rgba(76,175,80,0.3);">
                            <div class="gt-label">ğŸ’³ ××©××‘×™× ×©×©×•×œ××•</div>
                            <div class="gt-value" id="gtPaidResources-0">0 â‚ª</div>
                        </div>
                    </div>
                    <div class="grand-total-final">
                        ğŸ’ ×¡×”"×› ×›×œ×œ×™: <span id="gtGrandTotal-0">0</span> â‚ª
                    </div>
                </div>
            </div>

            <!-- Project Planning and Completion -->
            <div class="section">
                <h2 class="section-title">ğŸ“‹ ×ª×•×›× ×™×ª ×œ×¤×™×ª×•×— ×•×”×©×œ××ª ×”×¤×¨×•×™×§×˜</h2>
                
                <div class="input-field" style="margin-bottom: 20px;">
                    <label>×©× ×”×¤×¨×•×™×§×˜:</label>
                    <input type="text" id="planningProjectName-0" placeholder="×©× ×”×¤×¨×•×™×§×˜ ×”××ª×•×›× ×Ÿ">
                </div>

                <!-- Resources Planning -->
                <h3 style="color: #667eea; margin: 20px 0;">âš™ï¸ × ×™×”×•×œ ××©××‘×™× × ×“×¨×©×™×</h3>
                <div class="resource-list">
                    <div id="planningResourceList-0"></div>
                    <div class="add-resource-form">
                        <input type="text" id="planningResourceName-0" placeholder="×©× ×”××©××‘">
                        <input type="number" id="planningResourceCost-0" placeholder="×¢×œ×•×ª ×™×•××™×ª (â‚ª)" step="0.01">
                        <button onclick="addPlanningResource(0)">â• ×”×•×¡×£ ××©××‘</button>
                    </div>
                </div>

                <!-- Planning Summary Table -->
                <h3 style="color: #667eea; margin: 20px 0 10px;">ğŸ“Š ×”×¢×¨×›×•×ª ×•×”×©×œ××ª ×”×¤×¨×•×™×§×˜</h3>
                <div class="input-group" style="margin-bottom: 15px;">
                    <div class="input-field">
                        <label>×¡×”"×› ×™××™ ×¢×‘×•×“×” × ×“×¨×©×™×:</label>
                        <input type="number" id="plannedDays-0" value="0" min="0" step="1" onchange="updatePlanningCalculations(0)">
                    </div>
                    <div class="input-field">
                        <label>×©×¢×•×ª ×¢×‘×•×“×” ×‘×™×•×:</label>
                        <input type="number" id="plannedHoursPerDay-0" value="10" min="0" step="0.5" onchange="updatePlanningCalculations(0)">
                    </div>
                    <div class="input-field">
                        <label>×—×™×•×‘ ×©×¢×ª×™ ×œ××¤×ª×— ×¢× × ×™×¡×™×•×Ÿ (â‚ª):</label>
                        <input type="number" id="plannedHourlyRate-0" value="0" min="0" step="1" onchange="updatePlanningCalculations(0)">
                    </div>
                </div>

                <div class="summary" style="margin-top: 20px;">
                    <div class="summary-card">
                        <h3>ğŸ“… ×¡×”"×› ×™××™ ×¢×‘×•×“×”</h3>
                        <div class="summary-value" id="plannedTotalDays-0">0</div>
                        <div class="summary-label">×™××™×</div>
                    </div>
                    <div class="summary-card">
                        <h3>â° ×¡×”"×› ×©×¢×•×ª ×¢×‘×•×“×”</h3>
                        <div class="summary-value" id="plannedTotalHours-0">0</div>
                        <div class="summary-label">×©×¢×•×ª</div>
                    </div>
                    <div class="summary-card">
                        <h3>ğŸ’¸ ×¡×”"×› ××©××‘×™× × ×“×¨×©×™×</h3>
                        <div class="summary-value" id="plannedResourceCost-0">0</div>
                        <div class="summary-label">â‚ª</div>
                    </div>
                    <div class="summary-card">
                        <h3>ğŸ’° ×¡×”"×› ×”×©×§×¢×” × ×“×¨×©×ª</h3>
                        <div class="summary-value" id="plannedTotalCost-0">0</div>
                        <div class="summary-label">â‚ª</div>
                    </div>
                </div>

                <!-- Previous Investments -->
                <h3 style="color: #667eea; margin: 30px 0 10px;">ğŸ’µ ×¢×“×›×•×Ÿ ×¢×œ×•×™×•×ª ×¢×“ ×ª××¨×™×š</h3>
                <div class="input-group">
                    <div class="input-field">
                        <label>×ª××¨×™×š ×¢×“×›×•×Ÿ:</label>
                        <input type="date" id="costUpdateDate-0">
                    </div>
                    <div class="input-field">
                        <label>×¡×›×•× ×¡×•×¤×™ ×©×œ ×“×•×— ×§×•×“× (â‚ª):</label>
                        <input type="number" id="previousReportAmount-0" value="0" step="0.01" onchange="updateInvestmentSummary(0)">
                    </div>
                </div>

                <div class="financial-grid" style="margin-top: 20px;">
                    <div class="summary-card">
                        <h3>ğŸ’¼ ×¡×”"×› ×”×©×§×¢×•×ª ×§×•×“××•×ª</h3>
                        <div class="summary-value" id="previousInvestments-0">0</div>
                        <div class="summary-label">â‚ª</div>
                    </div>
                    <div class="summary-card">
                        <h3>ğŸš€ ×ª×—×–×™×ª ×”×©×§×¢×” ×—×“×©×”</h3>
                        <div class="summary-value" id="newInvestmentForecast-0">0</div>
                        <div class="summary-label">â‚ª</div>
                    </div>
                    <div class="summary-card" style="border: 3px solid #667eea;">
                        <h3>ğŸ¯ ×¡×”"×› ×›×œ×œ×™ ×”×©×§×¢×”</h3>
                        <div class="summary-value" style="color: #667eea;" id="totalProjectInvestment-0">0</div>
                        <div class="summary-label">×¢×“ ×”×ª×—×œ×ª ×©×™×•×•×§ (â‚ª)</div>
                    </div>
                </div>
            </div>

            <!-- Token Cost Calculator -->
            <div class="section">
                <h2 class="section-title">ğŸ¤– ××—×©×‘×•×Ÿ ×¢×œ×•×™×•×ª ×˜×•×§× ×™× - ×—×™×©×•×‘ ××¤×•×¨×˜</h2>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #ffc107;">
                    <h3 style="color: #856404; margin-bottom: 10px;">âš™ï¸ ×”×’×“×¨×•×ª ×§×‘×•×¢×•×ª</h3>
                    <div class="input-group">
                        <div class="input-field">
                            <label>×˜×•×§× ×™× ×œ×—×™×¤×•×© ×‘××ª×¨ (120 ×©× ×™×•×ª):</label>
                            <input type="number" id="tokensPerSearch-0" value="5000" step="100" onchange="calculateTokenCosts(0)">
                        </div>
                        <div class="input-field">
                            <label>××—×™×¨ ×œ××œ×£ ×˜×•×§× ×™× - Claude API ($):</label>
                            <input type="number" id="tokenPricePer1k-0" value="0.003" step="0.0001" onchange="calculateTokenCosts(0)">
                        </div>
                        <div class="input-field">
                            <label>×©×¢×¨ ×“×•×œ×¨ (â‚ª/$):</label>
                            <input type="number" id="usdToIls-0" value="3.7" step="0.01" onchange="calculateTokenCosts(0)">
                        </div>
                    </div>
                </div>

                <h3 style="color: #667eea; margin: 20px 0;">ğŸ“Š × ×ª×•× ×™ ×©×™××•×©</h3>
                <div class="input-group">
                    <div class="input-field">
                        <label>×›××•×ª ××˜×¤×œ×™ ×“×™×§×•×¨:</label>
                        <input type="number" id="numTherapists-0" value="0" min="0" step="1" onchange="calculateTokenCosts(0)">
                    </div>
                    <div class="input-field">
                        <label>×›××•×ª ×˜×™×¤×•×œ×™× ×™×•××™×ª (×œ×›×œ ××˜×¤×œ):</label>
                        <input type="number" id="treatmentsPerDay-0" value="0" min="0" step="1" onchange="calculateTokenCosts(0)">
                    </div>
                    <div class="input-field">
                        <label>×××•×¦×¢ ×˜×•×§× ×™× ×œ×›×œ ×˜×™×¤×•×œ:</label>
                        <input type="number" id="tokensPerTreatment-0" value="10000" step="100" onchange="calculateTokenCosts(0)">
                    </div>
                    <div class="input-field">
                        <label>×—×™×¤×•×©×™× ×™×•××™×™× ×‘××ª×¨ (×›×œ ××˜×¤×œ×™×):</label>
                        <input type="number" id="dailySearches-0" value="0" min="0" step="1" onchange="calculateTokenCosts(0)">
                    </div>
                    <div class="input-field">
                        <label>×™××™ ×˜×™×¤×•×œ ×—×•×“×©×™×™× ×¦×¤×•×™×™×:</label>
                        <input type="number" id="monthlyWorkDays-0" value="22" min="1" step="1" onchange="calculateTokenCosts(0)">
                    </div>
                </div>

                <h3 style="color: #667eea; margin: 20px 0;">ğŸ’° ×—×™×©×•×‘×™ ×¢×œ×•×™×•×ª</h3>
                <div class="summary">
                    <div class="summary-card">
                        <h3>ğŸ’µ ×¢×œ×•×ª ×˜×•×§× ×™× ×œ×˜×™×¤×•×œ</h3>
                        <div class="summary-value" id="costPerTreatment-0">0</div>
                        <div class="summary-label">â‚ª</div>
                    </div>
                    <div class="summary-card">
                        <h3>ğŸ’µ ×¢×œ×•×ª ×˜×•×§× ×™× ×œ×—×™×¤×•×©</h3>
                        <div class="summary-value" id="costPerSearch-0">0</div>
                        <div class="summary-label">â‚ª</div>
                    </div>
                    <div class="summary-card">
                        <h3>ğŸ“… ×¡×”"×› ×˜×•×§× ×™× ×™×•××™×™×</h3>
                        <div class="summary-value" id="dailyTotalTokens-0">0</div>
                        <div class="summary-label">×˜×•×§× ×™×</div>
                    </div>
                    <div class="summary-card">
                        <h3>ğŸ’¸ ×¢×œ×•×ª ×™×•××™×ª ×›×•×œ×œ×ª</h3>
                        <div class="summary-value" id="dailyTokenCost-0">0</div>
                        <div class="summary-label">â‚ª</div>
                    </div>
                    <div class="summary-card" style="border: 3px solid #667eea;">
                        <h3>ğŸ¯ ×¡×”"×› ×¢×œ×•×ª ×—×•×“×©×™×ª</h3>
                        <div class="summary-value" style="color: #667eea;" id="monthlyTokenCost-0">0</div>
                        <div class="summary-label">â‚ª/×—×•×“×©</div>
                    </div>
                </div>

                <h3 style="color: #667eea; margin: 30px 0 10px;">ğŸ¯ ×”××œ×¦×ª BOT AI - ×›××•×ª ×˜×•×§× ×™× ×œ××˜×¤×œ</h3>
                <div class="input-group" style="margin-bottom: 15px;">
                    <div class="input-field">
                        <label>××—×™×¨ ×× ×•×™ ×—×•×“×©×™ ($):</label>
                        <input type="number" id="subscriptionPriceUsd-0" value="8" step="0.01" onchange="calculateTokenRecommendation(0)">
                    </div>
                </div>

                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 12px; color: white;">
                    <h3 style="text-align: center; margin-bottom: 20px;">ğŸ’¡ ×”××œ×¦×ª ××¢×¨×›×ª</h3>
                    <div class="inline-grid-panel">
                        <div class="inline-grid-cell">
                            <div style="font-size: 0.9em; margin-bottom: 10px;">×˜×•×§× ×™× ××•××œ×¦×™× ×œ×—×•×“×©</div>
                            <div style="font-size: 1.8em; font-weight: bold;" id="recommendedMonthlyTokens-0">0</div>
                        </div>
                        <div class="inline-grid-cell">
                            <div style="font-size: 0.9em; margin-bottom: 10px;">×˜×™×¤×•×œ×™× ××•××œ×¦×™× ×œ×—×•×“×©</div>
                            <div style="font-size: 1.8em; font-weight: bold;" id="recommendedTreatments-0">0</div>
                        </div>
                        <div class="inline-grid-cell">
                            <div style="font-size: 0.9em; margin-bottom: 10px;">×¨×•×•×— × ×˜×• ××× ×•×™ (â‚ª)</div>
                            <div style="font-size: 1.8em; font-weight: bold;" id="profitPerSubscriber-0">0</div>
                        </div>
                        <div class="inline-grid-cell">
                            <div style="font-size: 0.9em; margin-bottom: 10px;">××—×•×– ×¨×•×•×— ××× ×•×™</div>
                            <div style="font-size: 1.8em; font-weight: bold;" id="profitMargin-0">0%</div>
                        </div>
                    </div>
                    <div class="inline-result-box">
                        <div id="aiRecommendation-0" style="font-size: 1.1em; line-height: 1.6;">
                            ×”×–×Ÿ × ×ª×•× ×™× ×œ×§×‘×œ×ª ×”××œ×¦×” ××•×˜×•××˜×™×ª
                        </div>
                    </div>
                </div>

                <h3 style="color: #667eea; margin: 30px 0 10px;">ğŸ“ˆ ×—×™×©×•×‘ ROI ×œ×œ×§×•×—</h3>
                <div class="input-group">
                    <div class="input-field">
                        <label>×”×•×¦××•×ª ×§×‘×•×¢×•×ª ×—×•×“×©×™×•×ª (â‚ª):</label>
                        <input type="number" id="fixedMonthlyCosts-0" value="0" step="0.01" onchange="calculateClientROI(0)">
                        <small style="color: #666;">×”×¢×ª×§ ×"×¡×”"×› ×¢×œ×•×™×•×ª ×ª×—×–×•×§×” ×—×•×“×©×™×•×ª" ×œ××˜×”</small>
                    </div>
                    <div class="input-field">
                        <label>×¢×œ×•×ª ×˜×•×§× ×™× ×××•×¦×¢×ª (â‚ª/×—×•×“×©):</label>
                        <input type="number" id="avgTokenCostInput-0" value="0" step="0.01" readonly style="background: #f0f0f0;">
                        <small style="color: #666;">××ª×¢×“×›×Ÿ ××•×˜×•××˜×™×ª ××”×—×™×©×•×‘ ×œ××¢×œ×”</small>
                    </div>
                    <div class="input-field">
                        <label>×›××•×ª ×× ×•×™×™× ××©×•×¢×¨×ª:</label>
                        <input type="number" id="estimatedSubscribers-0" value="0" min="0" step="1" onchange="calculateClientROI(0)">
                    </div>
                    <div class="input-field">
                        <label>×”×›× ×¡×” ×—×•×“×©×™×ª ××× ×•×™×™× (â‚ª):</label>
                        <input type="number" id="monthlySubscriptionRevenue-0" value="0" step="0.01" onchange="calculateClientROI(0)">
                    </div>
                </div>

                <div class="financial-summary" style="margin-top: 20px;">
                    <h2>ğŸ’¼ ×“×•×— ROI ×œ×œ×§×•×—</h2>
                    <div class="financial-grid">
                        <div class="financial-item">
                            <div class="label">ğŸ’° ×”×›× ×¡×•×ª ×—×•×“×©×™×•×ª</div>
                            <div class="value" id="roiTotalRevenue-0">0 â‚ª</div>
                        </div>
                        <div class="financial-item">
                            <div class="label">ğŸ’¸ ×”×•×¦××•×ª ×§×‘×•×¢×•×ª</div>
                            <div class="value" id="roiFixedCosts-0">0 â‚ª</div>
                        </div>
                        <div class="financial-item">
                            <div class="label">ğŸ¤– ×¢×œ×•×™×•×ª ×˜×•×§× ×™×</div>
                            <div class="value" id="roiTokenCosts-0">0 â‚ª</div>
                        </div>
                        <div class="financial-item">
                            <div class="label">ğŸ’µ ×¨×•×•×— ×—×•×“×©×™ × ×˜×•</div>
                            <div class="value net-profit" id="roiNetProfit-0">0 â‚ª</div>
                        </div>
                    </div>
                    <div class="inline-result-box">
                        <div style="font-size: 1.2em; margin-bottom: 10px;">â±ï¸ ×¦×¤×™ ×”×—×–×¨ ×”×©×§×¢×” ×¨××©×•× ×™×ª</div>
                        <div style="font-size: 2em; font-weight: bold;" id="roiPaybackMonths-0">- ×—×•×“×©×™×</div>
                    </div>
                </div>
            </div>

            <!-- Monthly Maintenance Costs -->
            <div class="section">
                <h2 class="section-title">ğŸ”§ ×¢×œ×•×™×•×ª ×§×‘×•×¢×•×ª ×œ×ª×—×–×•×§×ª ×”××ª×¨ - ×§×œ×™× ×™×§×” ×œ×“×™×§×•×¨</h2>
                
                <div class="input-group" style="margin-bottom: 20px;">
                    <div class="input-field">
                        <label>××™×—×¡×•×Ÿ ×”××ª×¨ (â‚ª/×—×•×“×©):</label>
                        <input type="number" id="hostingCost-0" value="0" step="0.01" onchange="updateMaintenanceCosts(0)">
                    </div>
                    <div class="input-field">
                        <label>×¢×œ×•×ª ×××•×¦×¢×ª ×©×œ ×˜×•×§× ×™× (â‚ª/×—×•×“×©):</label>
                        <input type="number" id="tokenCost-0" value="0" step="0.01" onchange="updateMaintenanceCosts(0)">
                    </div>
                    <div class="input-field">
                        <label>×©×¢×•×ª ×ª×—×–×•×§×” (×©×¢×•×ª/×—×•×“×©):</label>
                        <input type="number" id="maintenanceHours-0" value="0" step="0.5" onchange="updateMaintenanceCosts(0)">
                    </div>
                    <div class="input-field">
                        <label>×ª×¢×¨×™×£ ×©×¢×ª×™ ××ª×›× ×ª (â‚ª/×©×¢×”):</label>
                        <input type="number" id="programmerRate-0" value="0" step="1" onchange="updateMaintenanceCosts(0)">
                    </div>
                    <div class="input-field">
                        <label>×¢××œ×•×ª ×’×‘×™×™×ª ×ª×©×œ×•××™× (â‚ª/×—×•×“×©):</label>
                        <input type="number" id="paymentFees-0" value="0" step="0.01" onchange="updateMaintenanceCosts(0)">
                    </div>
                    <div class="input-field">
                        <label>×”×•×¦××•×ª ×©×•× ×•×ª (â‚ª/×—×•×“×©):</label>
                        <input type="number" id="otherFixedCosts-0" value="0" step="0.01" onchange="updateMaintenanceCosts(0)">
                    </div>
                </div>

                <h3 style="color: #667eea; margin: 20px 0;">ğŸ› ï¸ ×ª×•×›× ×•×ª ×œ×ª×—×–×•×§×”</h3>
                <div id="softwareList-0" style="margin-bottom: 15px;"></div>
                <div class="add-resource-form">
                    <input type="text" id="softwareName-0" placeholder="×©× ×”×ª×•×›× ×”">
                    <input type="number" id="softwareCost-0" placeholder="×¢×œ×•×ª ×—×•×“×©×™×ª (â‚ª)" step="0.01">
                    <button onclick="addSoftware(0)">â• ×”×•×¡×£ ×ª×•×›× ×”</button>
                </div>

                <h3 style="color: #667eea; margin: 20px 0;">ğŸ“ ×¢×œ×•×™×•×ª ×©×•× ×•×ª</h3>
                <div id="miscCostsList-0" style="margin-bottom: 15px;"></div>
                <div class="add-resource-form">
                    <input type="text" id="miscCostName-0" placeholder="×ª×™××•×¨ ×”×¢×œ×•×ª">
                    <input type="number" id="miscCostAmount-0" placeholder="×¡×›×•× (â‚ª)" step="0.01">
                    <button onclick="addMiscCost(0)">â• ×”×•×¡×£ ×¢×œ×•×ª</button>
                </div>

                <div class="summary-card" style="margin-top: 20px; background: #fff3cd; border: 2px solid #ffc107;">
                    <h3 style="color: #856404;">ğŸ’° ×¡×”"×› ×¢×œ×•×™×•×ª ×ª×—×–×•×§×” ×—×•×“×©×™×•×ª</h3>
                    <div class="summary-value" style="color: #856404;" id="totalMonthlyCosts-0">0</div>
                    <div class="summary-label">â‚ª ×œ×—×•×“×©</div>
                </div>
            </div>

            <!-- Revenue Forecast -->
            <div class="section">
                <h2 class="section-title">ğŸ“ˆ ×ª×—×–×™×ª ×”×›× ×¡×•×ª ×—×•×“×©×™×ª</h2>
                
                <div class="input-group">
                    <div class="input-field">
                        <label>×›××•×ª ×× ×•×™×™× ×—×•×“×©×™×ª:</label>
                        <input type="number" id="monthlySubscribers-0" value="0" min="0" step="1" onchange="updateRevenueCalculations(0)">
                    </div>
                    <div class="input-field">
                        <label>××—×™×¨ ×× ×•×™ ×—×•×“×©×™ (â‚ª):</label>
                        <input type="number" id="subscriptionPrice-0" value="0" min="0" step="0.01" onchange="updateRevenueCalculations(0)">
                    </div>
                    <div class="input-field">
                        <label>×”×›× ×¡×•×ª × ×•×¡×¤×•×ª (â‚ª/×—×•×“×©):</label>
                        <input type="number" id="additionalRevenue-0" value="0" min="0" step="0.01" onchange="updateRevenueCalculations(0)">
                    </div>
                </div>

                <div class="summary-card" style="margin-top: 20px; background: #d4edda; border: 2px solid #28a745;">
                    <h3 style="color: #155724;">ğŸ’µ ×¡×”"×› ×”×›× ×¡×” ×—×•×“×©×™×ª ×¦×¤×•×™×”</h3>
                    <div class="summary-value" style="color: #155724;" id="totalMonthlyRevenue-0">0</div>
                    <div class="summary-label">â‚ª ×œ×—×•×“×©</div>
                </div>
            </div>

            <!-- Final Profit/Loss Report -->
            <div class="financial-summary">
                <h2>ğŸ“Š ×“×•×— ××¡×›× ×¡×•×¤×™ - ×¨×•×•×—/×”×¤×¡×“ ×—×•×“×©×™</h2>
                <div class="financial-grid">
                    <div class="financial-item">
                        <div class="label">ğŸ’° ×”×›× ×¡×•×ª ×—×•×“×©×™×•×ª</div>
                        <div class="value" id="finalMonthlyRevenue-0">0 â‚ª</div>
                    </div>
                    <div class="financial-item">
                        <div class="label">ğŸ’¸ ×”×•×¦××•×ª ×ª×—×–×•×§×”</div>
                        <div class="value" id="finalMonthlyCosts-0">0 â‚ª</div>
                    </div>
                    <div class="financial-item">
                        <div class="label" id="profitLossLabel-0">ğŸ’µ ×¨×•×•×— ×—×•×“×©×™</div>
                        <div class="value net-profit" id="monthlyProfitLoss-0">0 â‚ª</div>
                    </div>
                    <div class="financial-item">
                        <div class="label">â±ï¸ ×–××Ÿ ×”×—×–×¨ ×”×©×§×¢×”</div>
                        <div class="value" id="roiMonths-0">- ×—×•×“×©×™×</div>
                    </div>
                </div>

                <div class="inline-result-box" style="background: rgba(255,255,255,0.2);">
                    <h3 style="margin-bottom: 15px;">ğŸ¯ ×”××œ×¦×” ×œ××™× ×™××•× ×× ×•×™×™×</h3>
                    <div style="font-size: 1.2em; margin-bottom: 10px;">
                        <strong>××™× ×™××•× ×× ×•×™×™× ×œ×™×¦×™×¨×ª ×¨×•×•×— ×—×•×“×©×™:</strong>
                    </div>
                    <div style="font-size: 2em; font-weight: bold;" id="minSubscribersRecommendation-0">0</div>
                    <div style="margin-top: 10px; font-size: 0.9em; opacity: 0.9;">
                        * ×—×™×©×•×‘ ××‘×•×¡×¡ ×¢×œ ×¢×œ×•×™×•×ª ×ª×—×–×•×§×” ×—×•×“×©×™×•×ª ××•×œ ××—×™×¨ ×× ×•×™
                    </div>
                </div>
            </div>

            <!-- Financial Summary -->
            <div class="financial-summary">
                <h2>ğŸ’° ×¡×™×›×•× ×¤×™× × ×¡×™ ×¡×•×¤×™</h2>
                <div class="financial-grid">
                    <div class="financial-item">
                        <div class="label">×¡×›×•× ×œ×—×™×•×‘ ×œ×¤×™ ×ª×¢×¨×™×£ ××¤×ª×— ×¢×¦×××™ ×¢× × ×¡×™×•×Ÿ</div>
                        <div class="value" id="grossIncome-0">0 â‚ª</div>
                    </div>
                    <div class="financial-item">
                        <div class="label">×¢×œ×•×™×•×ª ××©××‘×™×</div>
                        <div class="value" id="resourceCosts-0">0 â‚ª</div>
                    </div>
                    <div class="financial-item">
                        <div class="label">ğŸ’µ ×¡×›×•× ×œ×—×™×•×‘ ××—×¨×™ ×”×ª×××•×ª ×”× ×—×ª ××¤×ª×— ×œ×œ× × ×¡×™×•×Ÿ ×•×”× ×—×ª ×œ×¤×™ ×§×¦×‘ ×‘×™×¦×•×¢</div>
                        <div class="value net-profit" id="netProfit-0">0 â‚ª</div>
                    </div>
                    <div class="financial-item">
                        <div class="label">×©×›×¨ ×©×¢×ª×™ ×××•×¦×¢ × ×˜×•</div>
                        <div class="value" id="avgHourlyRate-0">0 â‚ª/×©×¢×”</div>
                    </div>
                </div>

                <!-- Payment Tracking -->
                <div class="payment-section" style="margin-top: 30px;">
                    <h3 style="text-align: center; margin-bottom: 20px;">ğŸ’³ ××¢×§×‘ ×ª×©×œ×•××™×</h3>
                    <div class="payment-form">
                        <div>
                            <label>×ª××¨×™×š ×—×™×•×‘:</label>
                            <input type="date" id="invoiceDate-0">
                        </div>
                        <div>
                            <label>×¡×›×•× ×—×™×•×‘ (â‚ª):</label>
                            <input type="number" id="invoiceAmount-0" step="0.01">
                        </div>
                        <div>
                            <label>×ª××¨×™×š ×ª×©×œ×•×:</label>
                            <input type="date" id="paymentDate-0">
                        </div>
                        <div>
                            <label>×¡×›×•× ×”×ª×§×‘×œ (â‚ª):</label>
                            <input type="number" id="paymentAmount-0" step="0.01">
                        </div>
                        <div class="payment-full-width">
                            <label>×”×¢×¨×•×ª ×ª×©×œ×•×:</label>
                            <input type="text" id="paymentNotes-0" placeholder="×”×¢×¨×•×ª ×¢×œ ×”×—×™×•×‘/×ª×©×œ×•×">
                        </div>
                    </div>
                    <button class="payment-add-btn" onclick="addPaymentRecord(0)">â• ×”×•×¡×£ ×¨×©×•××ª ×ª×©×œ×•×</button>
                    
                    <div id="paymentRecords-0" style="margin-top: 20px;"></div>
                    
                    <div class="inline-result-box">
                        <div style="font-size: 1.2em; margin-bottom: 10px;">ğŸ’° ×™×ª×¨×” ×œ×ª×©×œ×•×</div>
                        <div style="font-size: 2em; font-weight: bold;" id="balanceDue-0">0 â‚ª</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report History Section -->
        <div class="section report-history-section" style="margin-top: 30px;">
            <h2 class="section-title">ğŸ“ ×”×™×¡×˜×•×¨×™×™×ª ×“×•×—×•×ª ×©× ×©××¨×•</h2>
            <div class="table-wrapper">
                <table id="reportHistoryTable">
                    <thead>
                        <tr>
                            <th>×©× ×§×•×‘×¥</th>
                            <th>×ª××¨×™×š ×•×©×¢×”</th>
                            <th>×¤×¢×•×œ×•×ª</th>
                        </tr>
                    </thead>
                    <tbody id="reportHistoryBody"></tbody>
                </table>
            </div>
            <div style="margin-top: 15px;">
                <button class="btn" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); width: 100%;" onclick="loadReportFromFile()">ğŸ“‚ ×˜×¢×Ÿ ×“×•×— ××§×•×‘×¥ JSON</button>
            </div>
        </div>
    </div>

    <script>
        // Global data structure
        let projects = {
            0: {
                name: '×¤×¨×•×™×§×˜ ×¨××©×™',
                resources: {
                    'CLAUDE': 10,
                    'CHATGPT': 8,
                    'PERPLEXITY': 5
                },
                entries: [],
                payments: [],
                planningResources: {},
                softwareList: [],
                miscCosts: []
            }
        };
        let projectCounter = 1;
        let currentProject = 0;
        let autoSaveIntervals = {};
        let savedReports = JSON.parse(localStorage.getItem('savedReports') || '[]');

        // Initialize on load
        window.onload = function() {
            initializeProject(0);
            loadFromLocalStorage();
            loadProjectFromUrl();
            renderReportHistory();
        };

        // === Project-level Paid Resources ===
        function savePaidResources(projectId) {
            const amount = parseFloat(document.getElementById(`paidResourcesAmount-${projectId}`).value) || 0;
            const date = document.getElementById(`paidResourcesDate-${projectId}`).value || '';
            
            projects[projectId].paidResourcesTotal = amount;
            projects[projectId].paidResourcesDate = date;
            
            // Show confirmation
            const statusEl = document.getElementById(`paidResourcesStatus-${projectId}`);
            if (statusEl) {
                statusEl.textContent = 'âœ… × ×©××¨: ' + fmtNum(amount) + ' â‚ª' + (date ? ' | ' + date : '');
                setTimeout(() => { statusEl.textContent = ''; }, 3000);
            }
            
            updateSummary(projectId);
            renderTable(projectId);
            saveToLocalStorage();
        }

        function initializeProject(projectId) {
            updateResourceList(projectId);
            updateResourceSelect(projectId);
            renderTable(projectId);
            updateSummary(projectId);
            updatePlanningResourceList(projectId);
            renderSoftwareList(projectId);
            renderMiscCosts(projectId);
            updatePlanningCalculations(projectId);
            updateMaintenanceCosts(projectId);
            updateRevenueCalculations(projectId);
            
            // Load project-level paid resources into form
            const paidAmtEl = document.getElementById(`paidResourcesAmount-${projectId}`);
            const paidDateEl = document.getElementById(`paidResourcesDate-${projectId}`);
            if (paidAmtEl && projects[projectId].paidResourcesTotal) {
                paidAmtEl.value = projects[projectId].paidResourcesTotal;
            }
            if (paidDateEl && projects[projectId].paidResourcesDate) {
                paidDateEl.value = projects[projectId].paidResourcesDate;
            }
        }

        function addNewProject() {
            const projectName = prompt('×”×›× ×¡ ×©× ×œ×¤×¨×•×™×§×˜ ×”×—×“×©:', `×¤×¨×•×™×§×˜ ${projectCounter + 1}`);
            if (!projectName) return;

            const newProjectId = projectCounter++;
            projects[newProjectId] = {
                name: projectName,
                resources: { ...projects[0].resources },
                entries: [],
                payments: [],
                planningResources: {},
                softwareList: [],
                miscCosts: []
            };

            // Add tab
            const tabsContainer = document.getElementById('projectTabs');
            const addBtn = tabsContainer.querySelector('.add-project-btn');
            const newTab = document.createElement('button');
            newTab.className = 'tab';
            newTab.dataset.project = newProjectId;
            newTab.innerHTML = `<span class="remove-tab" onclick="removeProject(${newProjectId}, event)">âœ–</span>${projectName}`;
            newTab.onclick = function() { switchProject(newProjectId); };
            tabsContainer.insertBefore(newTab, addBtn);

            // Create project content
            const mainContainer = document.querySelector('.container');
            const projectContent = document.querySelector('.project-content').cloneNode(true);
            projectContent.id = `project-${newProjectId}`;
            projectContent.className = 'project-content';
            
            // Update all IDs in cloned content
            projectContent.innerHTML = projectContent.innerHTML.replace(/\-0/g, `-${newProjectId}`);
            mainContainer.appendChild(projectContent);

            initializeProject(newProjectId);
            switchProject(newProjectId);
            saveToLocalStorage();
        }

        function removeProject(projectId, event) {
            event.stopPropagation();
            if (projectId === 0) {
                alert('×œ× × ×™×ª×Ÿ ×œ××—×•×§ ××ª ×”×¤×¨×•×™×§×˜ ×”×¨××©×™');
                return;
            }
            if (!confirm(`×”×× ×œ××—×•×§ ××ª ×”×¤×¨×•×™×§×˜ "${projects[projectId].name}"?`)) return;

            delete projects[projectId];
            document.querySelector(`[data-project="${projectId}"]`).remove();
            document.getElementById(`project-${projectId}`).remove();
            
            if (currentProject === projectId) {
                switchProject(0);
            }
            saveToLocalStorage();
        }

        function switchProject(projectId) {
            currentProject = projectId;
            
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.project == projectId);
            });

            // Update content
            document.querySelectorAll('.project-content').forEach(content => {
                content.classList.toggle('active', content.id === `project-${projectId}`);
            });
        }

        function addResource(projectId) {
            const nameInput = document.getElementById(`newResourceName-${projectId}`);
            const costInput = document.getElementById(`newResourceCost-${projectId}`);
            
            const name = nameInput.value.trim();
            const cost = parseFloat(costInput.value);

            if (!name || isNaN(cost) || cost < 0) {
                alert('× × ×œ××œ× ×©× ××©××‘ ×•×¢×œ×•×ª ×ª×§×™× ×”');
                return;
            }

            projects[projectId].resources[name] = cost;
            nameInput.value = '';
            costInput.value = '';
            
            updateResourceList(projectId);
            updateResourceSelect(projectId);
            saveToLocalStorage();
        }

        function updateResourceCost(projectId, resourceName, newCost) {
            projects[projectId].resources[resourceName] = parseFloat(newCost);
            updateResourceSelect(projectId);
            renderTable(projectId);
            updateSummary(projectId);
            saveToLocalStorage();
        }

        function removeResource(projectId, resourceName) {
            if (confirm(`×”×× ×œ××—×•×§ ××ª ×”××©××‘ "${resourceName}"?`)) {
                delete projects[projectId].resources[resourceName];
                updateResourceList(projectId);
                updateResourceSelect(projectId);
                saveToLocalStorage();
            }
        }

        function updateResourceList(projectId) {
            const container = document.getElementById(`resourceList-${projectId}`);
            container.innerHTML = '';
            
            for (const [name, cost] of Object.entries(projects[projectId].resources)) {
                const div = document.createElement('div');
                div.className = 'resource-item';
                div.innerHTML = `
                    <strong>${name}</strong>
                    <div>
                        <input type="number" value="${cost}" step="0.01" 
                               onchange="updateResourceCost(${projectId}, '${name}', this.value)">
                        <span> â‚ª/×™×•×</span>
                        <button onclick="removeResource(${projectId}, '${name}')">ğŸ—‘ï¸</button>
                    </div>
                `;
                container.appendChild(div);
            }
        }

        function updateResourceSelect(projectId) {
            const container = document.getElementById(`resourceSelect-${projectId}`);
            container.innerHTML = '';
            
            for (const [name, cost] of Object.entries(projects[projectId].resources)) {
                const tag = document.createElement('div');
                tag.className = 'resource-tag';
                tag.textContent = `${name} (${cost} â‚ª/×™×•×)`;
                tag.onclick = function() { this.classList.toggle('selected'); };
                container.appendChild(tag);
            }
        }

        function getSelectedResources(projectId) {
            const selected = [];
            document.querySelectorAll(`#resourceSelect-${projectId} .resource-tag.selected`).forEach(tag => {
                const name = tag.textContent.split(' (')[0];
                selected.push(name);
            });
            return selected;
        }

        function calculateDaysBetweenDates(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 to include both start and end dates
            return diffDays;
        }

        function fmtNum(n) {
            return Number(n).toLocaleString('he-IL', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }
        function fmtInt(n) {
            return Number(n).toLocaleString('he-IL');
        }

        function previewCalculation(projectId) {
            const startDate = document.getElementById(`startDate-${projectId}`).value;
            const endDate = document.getElementById(`endDate-${projectId}`).value;
            const hoursPerDay = parseFloat(document.getElementById(`hours-${projectId}`).value) || 0;
            const hourlyRate = parseFloat(document.getElementById(`hourlyRate-${projectId}`).value) || 0;
            const discountPct = parseFloat(document.getElementById(`discountPct-${projectId}`).value) || 0;
            const selectedResources = getSelectedResources(projectId);
            
            const preview = document.getElementById(`calcPreview-${projectId}`);
            
            if (!startDate || !endDate) {
                alert('× × ×œ××œ× ×ª××¨×™×š ×”×ª×—×œ×” ×•×ª××¨×™×š ×¡×™×•×');
                return;
            }
            
            const workDays = calculateDaysBetweenDates(startDate, endDate);
            const totalHours = workDays * hoursPerDay;
            const workCharge = totalHours * hourlyRate;
            
            // Discount calculation
            const discountAmt = workCharge * (discountPct / 100);
            const workAfterDiscount = workCharge - discountAmt;
            
            // Resource details
            let resourceCost = 0;
            const resContainer = document.getElementById(`prevResourceLines-${projectId}`);
            resContainer.innerHTML = '';
            
            if (selectedResources.length > 0) {
                selectedResources.forEach(name => {
                    const dailyCost = projects[projectId].resources[name] || 0;
                    const totalCost = dailyCost * workDays;
                    resourceCost += totalCost;
                    const line = document.createElement('div');
                    line.className = 'resource-detail-line';
                    line.innerHTML = `<span class="rd-name">âš™ï¸ ${name}</span><span class="rd-calc">${fmtNum(dailyCost)} â‚ª/×™×•× Ã— ${workDays} ×™××™×</span><span class="rd-total">${fmtNum(totalCost)} â‚ª</span>`;
                    resContainer.appendChild(line);
                });
                // Total line
                const totalLine = document.createElement('div');
                totalLine.className = 'resource-detail-total';
                totalLine.innerHTML = `<span>×¡×”"×› ×¢×œ×•×ª ××©××‘×™×</span><span>${fmtNum(resourceCost)} â‚ª</span>`;
                resContainer.appendChild(totalLine);
            } else {
                resContainer.innerHTML = '<div style="color:#999; padding: 10px; text-align:center;">×œ× × ×‘×—×¨×• ××©××‘×™×</div>';
            }
            
            const grandTotal = workAfterDiscount + resourceCost;
            
            // Project-level paid resources
            const paidAmount = projects[projectId].paidResourcesTotal || 0;
            const paidDate = projects[projectId].paidResourcesDate || '-';
            const netResourceCost = resourceCost - paidAmount;
            const grandTotalNet = workAfterDiscount + netResourceCost;
            
            // Sync discount to entry form
            const entryDiscount = document.getElementById(`discountEntry-${projectId}`);
            if (entryDiscount) entryDiscount.value = discountPct;
            
            document.getElementById(`prevDays-${projectId}`).textContent = fmtInt(workDays);
            document.getElementById(`prevHours-${projectId}`).textContent = fmtInt(totalHours);
            document.getElementById(`prevRate-${projectId}`).textContent = fmtNum(hourlyRate) + ' â‚ª';
            document.getElementById(`prevWorkCost-${projectId}`).textContent = fmtNum(workCharge) + ' â‚ª';
            document.getElementById(`prevDiscountAmt-${projectId}`).textContent = fmtNum(discountAmt) + ' â‚ª';
            document.getElementById(`prevWorkAfterDiscount-${projectId}`).textContent = fmtNum(workAfterDiscount) + ' â‚ª';
            document.getElementById(`prevPaidResources-${projectId}`).textContent = fmtNum(paidAmount) + ' â‚ª';
            document.getElementById(`prevPaidDate-${projectId}`).textContent = paidDate || '-';
            document.getElementById(`prevNetResourceCost-${projectId}`).textContent = fmtNum(netResourceCost) + ' â‚ª';
            document.getElementById(`prevTotal-${projectId}`).textContent = fmtNum(grandTotalNet);
            
            preview.classList.add('visible');
        }

        function addEntry(projectId) {
            const startDate = document.getElementById(`startDate-${projectId}`).value;
            const endDate = document.getElementById(`endDate-${projectId}`).value;
            const topic = document.getElementById(`topic-${projectId}`).value;
            const component = document.getElementById(`component-${projectId}`).value;
            const hoursPerDay = parseFloat(document.getElementById(`hours-${projectId}`).value);
            const hourlyRate = parseFloat(document.getElementById(`hourlyRate-${projectId}`).value);
            const discountPct = parseFloat(document.getElementById(`discountEntry-${projectId}`)?.value) || 0;
            const notes = document.getElementById(`notes-${projectId}`).value;
            const selectedResources = getSelectedResources(projectId);

            if (!startDate || !endDate || !topic || !component) {
                alert('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”×—×•×‘×”');
                return;
            }

            const workDays = calculateDaysBetweenDates(startDate, endDate);
            const totalHours = workDays * hoursPerDay;

            let resourceCost = 0;
            selectedResources.forEach(resourceName => {
                resourceCost += (projects[projectId].resources[resourceName] || 0) * workDays;
            });

            const grossCharge = totalHours * hourlyRate;
            const discountAmt = grossCharge * (discountPct / 100);
            const chargeAfterDiscount = grossCharge - discountAmt;
            const netCharge = chargeAfterDiscount + resourceCost;

            const entry = {
                dateAdded: new Date().toLocaleString('he-IL'),
                startDate,
                endDate,
                workDays,
                totalHours,
                topic,
                component,
                resources: selectedResources,
                notes,
                resourceCost,
                hourlyRate,
                grossCharge,
                discountPct,
                discountAmt,
                chargeAfterDiscount,
                netCharge
            };

            projects[projectId].entries.push(entry);
            
            // Clear form (but NOT the paid resources â€” those are project-level)
            document.getElementById(`startDate-${projectId}`).value = '';
            document.getElementById(`endDate-${projectId}`).value = '';
            document.getElementById(`topic-${projectId}`).value = '';
            document.getElementById(`component-${projectId}`).value = '';
            document.getElementById(`notes-${projectId}`).value = '';
            document.querySelectorAll(`#resourceSelect-${projectId} .resource-tag`).forEach(tag => {
                tag.classList.remove('selected');
            });

            // Hide calculation preview
            const preview = document.getElementById(`calcPreview-${projectId}`);
            if (preview) preview.classList.remove('visible');

            renderTable(projectId);
            updateSummary(projectId);
            saveToLocalStorage();
        }

        function deleteEntry(projectId, index) {
            if (confirm('×”×× ×œ××—×•×§ ×¨×©×•××” ×–×•?')) {
                projects[projectId].entries.splice(index, 1);
                renderTable(projectId);
                updateSummary(projectId);
                saveToLocalStorage();
            }
        }

        function renderTable(projectId) {
            const tbody = document.querySelector(`#dataTable-${projectId} tbody`);
            tbody.innerHTML = '';

            const projectPaid = projects[projectId].paidResourcesTotal || 0;
            const totalEntries = projects[projectId].entries.length;

            projects[projectId].entries.forEach((entry, index) => {
                const dp = entry.discountPct || 0;
                const da = entry.discountAmt || 0;
                const cad = entry.chargeAfterDiscount !== undefined ? entry.chargeAfterDiscount : entry.grossCharge;
                const entryTotal = cad + entry.resourceCost;
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><span class="record-num">${index + 1}</span></td>
                    <td style="font-size:0.85em; color:#888;">${entry.dateAdded || '-'}</td>
                    <td>${entry.startDate}</td>
                    <td>${entry.endDate}</td>
                    <td>${fmtInt(entry.workDays)}</td>
                    <td>${fmtInt(entry.totalHours)}</td>
                    <td>${entry.topic}</td>
                    <td>${entry.component}</td>
                    <td>${entry.resources.join(', ')}</td>
                    <td>${entry.notes || '-'}</td>
                    <td>${fmtNum(entry.resourceCost)}</td>
                    <td style="background:#e8f5e9; color:#2e7d32; font-weight:700; text-align:center;">${index === 0 && projectPaid > 0 ? fmtNum(projectPaid) : '-'}</td>
                    <td>${fmtNum(entry.grossCharge)}</td>
                    <td>${dp > 0 ? dp + '%' : '-'}</td>
                    <td>${fmtNum(cad)}</td>
                    <td><strong>${fmtNum(entryTotal)}</strong></td>
                    <td><button class="delete-row-btn" onclick="deleteEntry(${projectId}, ${index})" title="××—×§ ×¨×©×•××”">ğŸ—‘ï¸</button></td>
                `;
            });
        }

        function updateSummary(projectId) {
            let totalDays = 0;
            let totalHours = 0;
            let totalResourceCost = 0;
            let totalGrossIncome = 0;
            let totalAfterDiscount = 0;

            projects[projectId].entries.forEach(entry => {
                totalDays += entry.workDays;
                totalHours += entry.totalHours;
                totalResourceCost += entry.resourceCost;
                totalGrossIncome += entry.grossCharge;
                totalAfterDiscount += (entry.chargeAfterDiscount !== undefined ? entry.chargeAfterDiscount : entry.grossCharge);
            });

            // Project-level paid resources (NOT per-entry)
            const totalPaidResources = projects[projectId].paidResourcesTotal || 0;
            const netResourceCost = totalResourceCost - totalPaidResources;
            const grandTotal = totalAfterDiscount + netResourceCost;
            const totalDiscount = totalGrossIncome - totalAfterDiscount;
            const avgHourlyRate = totalHours > 0 ? totalAfterDiscount / totalHours : 0;

            document.getElementById(`totalDays-${projectId}`).textContent = fmtInt(totalDays);
            document.getElementById(`totalHours-${projectId}`).textContent = fmtInt(totalHours);
            document.getElementById(`totalResourceCost-${projectId}`).textContent = fmtNum(totalResourceCost);
            const tpEl = document.getElementById(`totalPaidResources-${projectId}`);
            if (tpEl) tpEl.textContent = fmtNum(totalPaidResources);
            document.getElementById(`totalIncome-${projectId}`).textContent = fmtNum(totalAfterDiscount);
            
            document.getElementById(`grossIncome-${projectId}`).textContent = fmtNum(totalGrossIncome) + ' â‚ª';
            document.getElementById(`resourceCosts-${projectId}`).textContent = fmtNum(netResourceCost) + ' â‚ª';
            document.getElementById(`netProfit-${projectId}`).textContent = fmtNum(totalAfterDiscount - netResourceCost) + ' â‚ª';
            document.getElementById(`avgHourlyRate-${projectId}`).textContent = fmtNum(avgHourlyRate) + ' â‚ª/×©×¢×”';
            
            // Update Grand Total box
            const gtRecords = document.getElementById(`gtRecords-${projectId}`);
            if (gtRecords) {
                gtRecords.textContent = projects[projectId].entries.length;
                document.getElementById(`gtDays-${projectId}`).textContent = fmtInt(totalDays);
                document.getElementById(`gtHours-${projectId}`).textContent = fmtInt(totalHours);
                document.getElementById(`gtWorkCharge-${projectId}`).textContent = fmtNum(totalAfterDiscount) + ' â‚ª';
                document.getElementById(`gtResourceCost-${projectId}`).textContent = fmtNum(totalResourceCost) + ' â‚ª';
                const gtPaidEl = document.getElementById(`gtPaidResources-${projectId}`);
                if (gtPaidEl) gtPaidEl.textContent = fmtNum(totalPaidResources) + ' â‚ª';
                document.getElementById(`gtGrandTotal-${projectId}`).textContent = fmtNum(grandTotal);
            }

            updatePaymentBalance(projectId);
        }

        function addPaymentRecord(projectId) {
            const invoiceDate = document.getElementById(`invoiceDate-${projectId}`).value;
            const invoiceAmount = parseFloat(document.getElementById(`invoiceAmount-${projectId}`).value) || 0;
            const paymentDate = document.getElementById(`paymentDate-${projectId}`).value;
            const paymentAmount = parseFloat(document.getElementById(`paymentAmount-${projectId}`).value) || 0;
            const paymentNotes = document.getElementById(`paymentNotes-${projectId}`).value;

            if (!invoiceDate && !paymentDate) {
                alert('× × ×œ××œ× ×œ×¤×—×•×ª ×ª××¨×™×š ××—×“');
                return;
            }

            const record = {
                invoiceDate,
                invoiceAmount,
                paymentDate,
                paymentAmount,
                notes: paymentNotes
            };

            projects[projectId].payments.push(record);

            // Clear form
            document.getElementById(`invoiceDate-${projectId}`).value = '';
            document.getElementById(`invoiceAmount-${projectId}`).value = '';
            document.getElementById(`paymentDate-${projectId}`).value = '';
            document.getElementById(`paymentAmount-${projectId}`).value = '';
            document.getElementById(`paymentNotes-${projectId}`).value = '';

            renderPaymentRecords(projectId);
            updatePaymentBalance(projectId);
            saveToLocalStorage();
        }

        function renderPaymentRecords(projectId) {
            const container = document.getElementById(`paymentRecords-${projectId}`);
            container.innerHTML = '';

            projects[projectId].payments.forEach((record, index) => {
                const div = document.createElement('div');
                div.style.cssText = 'background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 10px;';
                div.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        ${record.invoiceDate ? `<div><strong>ğŸ“… ×ª××¨×™×š ×—×™×•×‘:</strong> ${record.invoiceDate}</div>` : ''}
                        ${record.invoiceAmount ? `<div><strong>ğŸ’µ ×¡×›×•× ×—×™×•×‘:</strong> ${record.invoiceAmount.toFixed(0)} â‚ª</div>` : ''}
                        ${record.paymentDate ? `<div><strong>ğŸ“… ×ª××¨×™×š ×ª×©×œ×•×:</strong> ${record.paymentDate}</div>` : ''}
                        ${record.paymentAmount ? `<div><strong>âœ… ×¡×›×•× ×”×ª×§×‘×œ:</strong> ${record.paymentAmount.toFixed(0)} â‚ª</div>` : ''}
                    </div>
                    ${record.notes ? `<div style="margin-top: 10px;"><strong>ğŸ“ ×”×¢×¨×•×ª:</strong> ${record.notes}</div>` : ''}
                    <button onclick="deletePaymentRecord(${projectId}, ${index})" style="margin-top: 10px; padding: 5px 15px; background: #ff4444; color: white; border: none; border-radius: 5px; cursor: pointer;">ğŸ—‘ï¸ ××—×§</button>
                `;
                container.appendChild(div);
            });
        }

        function deletePaymentRecord(projectId, index) {
            if (confirm('×”×× ×œ××—×•×§ ×¨×©×•××ª ×ª×©×œ×•× ×–×•?')) {
                projects[projectId].payments.splice(index, 1);
                renderPaymentRecords(projectId);
                updatePaymentBalance(projectId);
                saveToLocalStorage();
            }
        }

        function updatePaymentBalance(projectId) {
            let totalInvoiced = 0;
            let totalReceived = 0;

            projects[projectId].payments.forEach(record => {
                totalInvoiced += record.invoiceAmount || 0;
                totalReceived += record.paymentAmount || 0;
            });

            const balance = totalInvoiced - totalReceived;
            document.getElementById(`balanceDue-${projectId}`).textContent = balance.toFixed(0) + ' â‚ª';
        }

        function printProject(projectId) {
            const projectName = projects[projectId].name;
            const now = new Date();
            const dateStr = now.toLocaleDateString('he-IL');

            // Remove any previously injected print elements
            document.querySelectorAll('.print-injected').forEach(function(el) { el.remove(); });

            var projectContent = document.getElementById('project-' + projectId);
            if (!projectContent) return;

            var sectionTitles = [
                { match: '× ×™×”×•×œ ××©××‘×™×', title: '× ×™×”×•×œ ××©××‘×™×' },
                { match: '×”×•×¡×¤×ª ×¨×©×•××”', title: '×”×•×¡×¤×ª ×¨×©×•××” ×—×“×©×”' },
                { match: '×˜×‘×œ×ª × ×ª×•× ×™×', title: '×˜×‘×œ×ª × ×ª×•× ×™× + ×¡×™×›×•× ×›×•×œ×œ' },
                { match: '×ª×•×›× ×™×ª ×œ×¤×™×ª×•×—', title: '×ª×•×›× ×™×ª ×œ×¤×™×ª×•×— ×•×”×©×œ××ª ×”×¤×¨×•×™×§×˜' },
                { match: '××—×©×‘×•×Ÿ ×¢×œ×•×™×•×ª ×˜×•×§× ×™×', title: '××—×©×‘×•×Ÿ ×¢×œ×•×™×•×ª ×˜×•×§× ×™×' },
                { match: '×¢×œ×•×™×•×ª ×§×‘×•×¢×•×ª', title: '×¢×œ×•×™×•×ª ×§×‘×•×¢×•×ª ×œ×ª×—×–×•×§×”' },
                { match: '×ª×—×–×™×ª ×”×›× ×¡×•×ª', title: '×ª×—×–×™×ª ×”×›× ×¡×•×ª ×—×•×“×©×™×ª' }
            ];

            var pageNum = 1;

            function makeHeader(title, page) {
                var hdr = document.createElement('div');
                hdr.className = 'print-page-header print-injected';
                hdr.innerHTML =
                    '<div class="print-header-title">ğŸ“Š ' + projectName + '</div>' +
                    '<div class="print-header-sub">' + title + ' | ' + dateStr + ' | ×¢××•×“ ' + page + '</div>';
                return hdr;
            }

            function makeFooter(page) {
                var ftr = document.createElement('div');
                ftr.className = 'print-page-footer print-injected';
                ftr.innerHTML = '×™×•××Ÿ ×¤×¨×•×™×§×˜×™× ××ª×§×“× â€” ' + projectName + ' | ' + dateStr + ' | ×¢××•×“ ' + page;
                return ftr;
            }

            // Add headers/footers to each .section
            var allSections = projectContent.querySelectorAll('.section');
            allSections.forEach(function(section) {
                var titleEl = section.querySelector('.section-title');
                if (!titleEl) return;
                var titleText = titleEl.textContent.trim();

                var sectionTitle = titleText;
                for (var i = 0; i < sectionTitles.length; i++) {
                    if (titleText.indexOf(sectionTitles[i].match) !== -1) {
                        sectionTitle = sectionTitles[i].title;
                        break;
                    }
                }

                section.insertBefore(makeHeader(sectionTitle, pageNum), section.firstChild);
                section.appendChild(makeFooter(pageNum));
                pageNum++;
            });

            // Financial summaries get their own pages
            var financialSummaries = projectContent.querySelectorAll('.financial-summary');
            var financialTitles = [
                '×“×•×— ××¡×›× ×¡×•×¤×™ â€” ×¨×•×•×—/×”×¤×¡×“ ×—×•×“×©×™',
                '×¡×™×›×•× ×¤×™× × ×¡×™ ×¡×•×¤×™ ×•××¢×§×‘ ×ª×©×œ×•××™×'
            ];
            financialSummaries.forEach(function(fs, idx) {
                var title = financialTitles[idx] || '×¡×™×›×•× ×¤×™× × ×¡×™';
                fs.insertBefore(makeHeader(title, pageNum), fs.firstChild);
                fs.appendChild(makeFooter(pageNum));
                pageNum++;
            });

            // Print
            window.print();

            // Clean up
            setTimeout(function() {
                document.querySelectorAll('.print-injected').forEach(function(el) { el.remove(); });
            }, 1500);
        }

        function createShareableLink(projectId) {
            const projectName = projects[projectId].name;
            const projectData = JSON.stringify(projects[projectId]);
            const encodedData = btoa(encodeURIComponent(projectData));
            
            const baseUrl = window.location.href.split('?')[0];
            const shareUrl = `${baseUrl}?project=${encodedData}`;
            
            // Create a temporary input to copy the URL
            const tempInput = document.createElement('input');
            tempInput.value = shareUrl;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            
            alert(`×§×™×©×•×¨ ×œ×©×™×ª×•×£ ×”×¤×¨×•×™×§×˜ "${projectName}" ×”×•×¢×ª×§ ×œ×œ×•×—!\n\n× ×™×ª×Ÿ ×œ×©×œ×•×— ××•×ª×• ×œ××™×©×”×• ×•×”× ×ª×•× ×™× ×™×™×˜×¢× ×• ××•×˜×•××˜×™×ª.`);
        }

        function shareToWhatsApp(projectId) {
            const p = projects[projectId];
            const pName = p.name;
            const entries = p.entries || [];
            const gv = (id) => document.getElementById(id + '-' + projectId)?.textContent || '0';
            
            let sDays=0, sHours=0, sRes=0, sAfter=0, sTotal=0;
            const sPaid = p.paidResourcesTotal || 0;
            entries.forEach(e => {
                const cad = e.chargeAfterDiscount !== undefined ? e.chargeAfterDiscount : e.grossCharge;
                sDays += e.workDays; sHours += e.totalHours;
                sRes += e.resourceCost; sAfter += cad; sTotal += cad + e.resourceCost;
            });
            const sNetTotal = sTotal - sPaid;
            
            let msg = '*ğŸ“Š ×“×•×— ×¤×¨×•×™×§×˜×™× â€” ××‘×©×™ ×¡×¤×™×¨ â€” ××¤×ª×— ××ª×—×™×œ, ×¢×•×¡×§ ××•×¨×©×” 052866969*\n';
            msg += '*ğŸ“‹ ' + pName + '*\n\n';
            msg += 'ğŸ“‹ *' + entries.length + ' ×¨×©×•××•×ª*\n';
            msg += 'ğŸ“… ×™××™ ×¢×‘×•×“×”: ' + fmtInt(sDays) + '\n';
            msg += 'â° ×©×¢×•×ª: ' + fmtInt(sHours) + '\n';
            msg += 'ğŸ’° ×—×™×•×‘ ×¢×‘×•×“×”: ' + fmtNum(sAfter) + ' â‚ª\n';
            msg += 'âš™ï¸ ××©××‘×™×: ' + fmtNum(sRes) + ' â‚ª\n';
            msg += 'ğŸ’³ ××©××‘×™× ×©×©×•×œ××•: ' + fmtNum(sPaid) + ' â‚ª\n';
            msg += '\nğŸ’ *×¡×”"×› ×›×œ×œ×™: ' + fmtNum(sNetTotal) + ' â‚ª*\n';
            msg += '\nğŸ’µ ×¡×›×•× ×œ×—×™×•×‘ ××—×¨×™ ×”×ª×××•×ª: ' + gv('netProfit') + '\n';
            msg += 'ğŸ“ˆ ×©×›×¨ ×©×¢×ª×™ ×××•×¦×¢: ' + gv('avgHourlyRate') + '\n';
            
            window.open('https://wa.me/?text=' + encodeURIComponent(msg), '_blank');
        }

        function manualSave(projectId) {
            const projectName = projects[projectId].name;
            const now = new Date();
            const timestamp = now.getFullYear() + '-' + 
                            String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                            String(now.getDate()).padStart(2, '0') + '_' + 
                            String(now.getHours()).padStart(2, '0') + '-' + 
                            String(now.getMinutes()).padStart(2, '0') + '-' + 
                            String(now.getSeconds()).padStart(2, '0');
            
            const fileName = `${projectName.replace(/\s+/g, '_')}_${timestamp}.json`;
            const dataStr = JSON.stringify(projects[projectId], null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);
            
            addReportToHistory(fileName);
            alert(`×”×¤×¨×•×™×§×˜ × ×©××¨ ×‘×”×¦×œ×—×”!\n×©× ×”×§×•×‘×¥: ${fileName}`);
        }

        function toggleAutoSave(projectId) {
            const checkbox = document.getElementById(`autoSaveToggle-${projectId}`);
            const statusEl = document.getElementById(`autoSaveStatus-${projectId}`);
            
            if (checkbox.checked) {
                // Start auto-save
                autoSaveIntervals[projectId] = setInterval(() => {
                    autoSaveProject(projectId);
                }, 60000); // 60 seconds
                
                statusEl.textContent = 'âœ… ×¤×¢×™×œ - ×©××™×¨×” ×›×œ 60 ×©× ×™×•×ª';
                statusEl.style.color = '#4CAF50';
                
                alert('×©××™×¨×” ××•×˜×•××˜×™×ª ×”×•×¤×¢×œ×”! ×”×¤×¨×•×™×§×˜ ×™×™×©××¨ ××•×˜×•××˜×™×ª ×›×œ 60 ×©× ×™×•×ª.');
            } else {
                // Stop auto-save
                if (autoSaveIntervals[projectId]) {
                    clearInterval(autoSaveIntervals[projectId]);
                    delete autoSaveIntervals[projectId];
                }
                
                statusEl.textContent = 'â¸ï¸ ××•×©×‘×ª';
                statusEl.style.color = '#666';
            }
        }

        function autoSaveProject(projectId) {
            const projectName = projects[projectId].name;
            const now = new Date();
            const timestamp = now.getFullYear() + '-' + 
                            String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                            String(now.getDate()).padStart(2, '0') + '_' + 
                            String(now.getHours()).padStart(2, '0') + '-' + 
                            String(now.getMinutes()).padStart(2, '0') + '-' + 
                            String(now.getSeconds()).padStart(2, '0');
            
            const fileName = `${projectName.replace(/\s+/g, '_')}_autosave_${timestamp}.json`;
            const dataStr = JSON.stringify(projects[projectId], null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);
            
            addReportToHistory(fileName);

            // Update status
            const statusEl = document.getElementById(`autoSaveStatus-${projectId}`);
            if (statusEl) {
                const timeStr = String(now.getHours()).padStart(2, '0') + ':' + 
                               String(now.getMinutes()).padStart(2, '0');
                statusEl.textContent = `âœ… ×©××™×¨×” ××—×¨×•× ×”: ${timeStr}`;
            }
        }

        function loadProjectFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectData = urlParams.get('project');
            
            if (projectData) {
                try {
                    const decodedData = decodeURIComponent(atob(projectData));
                    const project = JSON.parse(decodedData);
                    
                    const newProjectId = projectCounter++;
                    projects[newProjectId] = project;
                    
                    // Add tab and content
                    const tabsContainer = document.getElementById('projectTabs');
                    const addBtn = tabsContainer.querySelector('.add-project-btn');
                    const newTab = document.createElement('button');
                    newTab.className = 'tab';
                    newTab.dataset.project = newProjectId;
                    newTab.innerHTML = `<span class="remove-tab" onclick="removeProject(${newProjectId}, event)">âœ–</span>${project.name}`;
                    newTab.onclick = function() { switchProject(newProjectId); };
                    tabsContainer.insertBefore(newTab, addBtn);

                    const mainContainer = document.querySelector('.container');
                    const projectContent = document.querySelector('.project-content').cloneNode(true);
                    projectContent.id = `project-${newProjectId}`;
                    projectContent.className = 'project-content';
                    projectContent.innerHTML = projectContent.innerHTML.replace(/\-0/g, `-${newProjectId}`);
                    mainContainer.appendChild(projectContent);

                    initializeProject(newProjectId);
                    switchProject(newProjectId);
                    
                    alert(`×¤×¨×•×™×§×˜ "${project.name}" × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”!`);
                } catch (e) {
                    console.error('Error loading project from URL:', e);
                }
            }
        }

        function sendEmail(projectId) {
            const p = projects[projectId];
            const pName = p.name;
            const entries = p.entries || [];
            const now = new Date();
            const dateStr = now.toLocaleString('he-IL');

            // Helper: format number with commas
            function rN(n, d) {
                if (d === 0) return Number(n).toLocaleString('he-IL');
                return Number(n).toLocaleString('he-IL', {minimumFractionDigits:2, maximumFractionDigits:2});
            }

            // Read summary values from DOM
            const gv = (id) => document.getElementById(id + '-' + projectId)?.textContent || '0';
            const gi = (id) => document.getElementById(id + '-' + projectId)?.value || '0';

            // Build table rows from data
            let rows = '';
            let sDays=0, sHours=0, sRes=0, sGross=0, sDisc=0, sAfter=0, sTotal=0;
            const sPaid = p.paidResourcesTotal || 0;
            entries.forEach((e, i) => {
                const dp = e.discountPct || 0;
                const cad = e.chargeAfterDiscount !== undefined ? e.chargeAfterDiscount : e.grossCharge;
                const tot = cad + e.resourceCost;
                sDays += e.workDays; sHours += e.totalHours;
                sRes += e.resourceCost; sGross += e.grossCharge;
                sDisc += (e.discountAmt || 0); sAfter += cad; sTotal += tot;
                rows += '<tr>' +
                    '<td style="text-align:center"><span style="background:#667eea;color:#fff;width:26px;height:26px;border-radius:50%;display:inline-block;line-height:26px;font-weight:700;font-size:0.85em">' + (i+1) + '</span></td>' +
                    '<td style="font-size:0.85em;color:#888">' + (e.dateAdded || '-') + '</td>' +
                    '<td>' + e.startDate + '</td><td>' + e.endDate + '</td>' +
                    '<td>' + rN(e.workDays,0) + '</td><td>' + rN(e.totalHours,0) + '</td>' +
                    '<td>' + e.topic + '</td><td>' + e.component + '</td>' +
                    '<td>' + (e.resources||[]).join(', ') + '</td>' +
                    '<td>' + (e.notes||'-') + '</td>' +
                    '<td>' + rN(e.resourceCost) + '</td>' +
                    '<td style="color:#2e7d32;font-weight:700;background:#e8f5e9">' + (i === 0 && sPaid > 0 ? rN(sPaid) : '-') + '</td>' +
                    '<td>' + rN(e.grossCharge) + '</td>' +
                    '<td>' + (dp > 0 ? dp+'%' : '-') + '</td>' +
                    '<td>' + rN(cad) + '</td>' +
                    '<td style="font-weight:800;background:#f0f7ff">' + rN(tot) + '</td></tr>';
            });
            const sNetTotal = sTotal - sPaid;
            // Totals row
            rows += '<tr style="background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;font-weight:800">' +
                '<td colspan="4" style="color:#fff;border-color:rgba(255,255,255,0.3)">×¡×”&quot;×›</td>' +
                '<td style="color:#fff;border-color:rgba(255,255,255,0.3)">' + rN(sDays,0) + '</td>' +
                '<td style="color:#fff;border-color:rgba(255,255,255,0.3)">' + rN(sHours,0) + '</td>' +
                '<td colspan="4" style="color:#fff;border-color:rgba(255,255,255,0.3)"></td>' +
                '<td style="color:#fff;border-color:rgba(255,255,255,0.3)">' + rN(sRes) + '</td>' +
                '<td style="color:#fff;border-color:rgba(255,255,255,0.3)">' + rN(sPaid) + '</td>' +
                '<td style="color:#fff;border-color:rgba(255,255,255,0.3)">' + rN(sGross) + '</td>' +
                '<td style="color:#fff;border-color:rgba(255,255,255,0.3)">' + rN(sDisc) + '</td>' +
                '<td style="color:#fff;border-color:rgba(255,255,255,0.3)">' + rN(sAfter) + '</td>' +
                '<td style="color:#fff;border-color:rgba(255,255,255,0.3);font-size:1.1em">' + rN(sNetTotal) + '</td></tr>';

            // Resources list
            let resList = '';
            for (const [nm, cost] of Object.entries(p.resources || {})) {
                resList += '<div style="display:flex;justify-content:space-between;padding:8px 14px;background:#f5f5f5;border-radius:6px;margin-bottom:5px">' +
                    '<span style="font-weight:600">' + nm + '</span>' +
                    '<span style="font-weight:700;color:#667eea">' + rN(cost) + ' â‚ª/×™×•×</span></div>';
            }

            // Build full HTML report
            var h = '\uFEFF'; // BOM for UTF-8
            h += '<!DOCTYPE html><html lang="he" dir="rtl"><head>';
            h += '<meta charset="UTF-8">';
            h += '<meta name="viewport" content="width=device-width,initial-scale=1.0">';
            h += '<title>×“×•×— ×¤×¨×•×™×§×˜×™× â€” ××‘×©×™ ×¡×¤×™×¨ â€” ' + pName + '</title>';
            h += '<style>';
            h += '*{margin:0;padding:0;box-sizing:border-box}';
            h += 'body{font-family:Segoe UI,Tahoma,Arial,sans-serif;background:#f0f2f5;padding:20px;direction:rtl;color:#333}';
            h += '.ctr{max-width:1200px;margin:0 auto;background:#fff;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.15);overflow:hidden}';
            h += '.hdr{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:30px;text-align:center}';
            h += '.hdr h1{font-size:2em;font-weight:800;margin-bottom:8px}.hdr p{opacity:.9;font-size:1.05em}';
            h += '.cnt{padding:25px}';
            h += '.sec{background:#f9f9f9;border:2px solid #e0e0e0;border-radius:12px;padding:20px;margin-bottom:20px}';
            h += '.sec h2{color:#667eea;font-size:1.3em;margin-bottom:15px;padding-bottom:10px;border-bottom:2px solid #667eea}';
            h += 'table{width:100%;border-collapse:collapse;font-size:.88em}';
            h += 'th{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:10px 8px;text-align:right;font-weight:700;white-space:nowrap}';
            h += 'td{padding:9px 8px;border-bottom:1px solid #e0e0e0;text-align:right}';
            h += 'tr:nth-child(even){background:#fafafa}';
            h += '.sg{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-top:15px}';
            h += '.sc{background:#fff;padding:18px;border-radius:10px;border:2px solid #e0e0e0;text-align:center}';
            h += '.sc h3{color:#667eea;font-size:.95em;margin-bottom:10px}.sc .v{font-size:1.8em;font-weight:800;color:#333}.sc .l{color:#666;margin-top:5px;font-size:.85em}';
            h += '.gt{background:linear-gradient(135deg,#1a237e,#4a148c);color:#fff;padding:25px;border-radius:12px;margin-top:20px;border:3px solid gold}';
            h += '.gt h2{text-align:center;margin-bottom:15px;color:#fff;border:none;padding:0}';
            h += '.gg{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:15px}';
            h += '.gc{background:rgba(255,255,255,.12);padding:14px;border-radius:8px;text-align:center}';
            h += '.gc .gl{font-size:.85em;opacity:.9;margin-bottom:6px}.gc .gv{font-size:1.6em;font-weight:800}';
            h += '.gf{background:gold;color:#1a237e;padding:16px;border-radius:10px;text-align:center;font-size:1.8em;font-weight:900}';
            h += '.fn{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:25px;border-radius:12px;margin-top:20px}';
            h += '.fn h2{text-align:center;margin-bottom:15px;color:#fff;border:none;padding:0}';
            h += '.fg{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}';
            h += '.fi{background:rgba(255,255,255,.12);padding:14px;border-radius:8px;text-align:center}';
            h += '.fi .fl{font-size:.85em;margin-bottom:6px}.fi .fv{font-size:1.5em;font-weight:800}';
            h += '.ft{text-align:center;padding:15px;color:#999;font-size:.85em;border-top:1px solid #eee;margin-top:20px}';
            h += '@media print{body{background:#fff;padding:0}.ctr{box-shadow:none}}';
            h += '</style></head><body>';
            h += '<div class="ctr">';

            // Header
            h += '<div class="hdr"><h1>\u{1F4CA} ×“×•×— ×¤×¨×•×™×§×˜×™× â€” ××‘×©×™ ×¡×¤×™×¨ â€” ××¤×ª×— ××ª×—×™×œ, ×¢×•×¡×§ ××•×¨×©×” 052866969</h1>';
            h += '<p>' + pName + ' | ×ª××¨×™×š ×”×¤×§×”: ' + dateStr + '</p></div>';
            h += '<div class="cnt">';

            // Resources section
            h += '<div class="sec"><h2>\u2699\uFE0F ××©××‘×™× ×‘×©×™××•×©</h2>';
            h += (resList || '<p style="color:#999">×œ× ×”×•×’×“×¨×• ××©××‘×™×</p>');
            h += '</div>';

            // Data table
            h += '<div class="sec" style="overflow-x:auto"><h2>\u{1F4CB} ×˜×‘×œ×ª × ×ª×•× ×™× â€” ' + entries.length + ' ×¨×©×•××•×ª</h2>';
            h += '<table><thead><tr>';
            h += '<th>#</th><th>× ×•×¡×£</th><th>×”×ª×—×œ×”</th><th>×¡×™×•×</th><th>×™××™×</th><th>×©×¢×•×ª</th>';
            h += '<th>× ×•×©×</th><th>××¨×›×™×‘</th><th>××©××‘×™×</th><th>×”×¢×¨×•×ª</th>';
            h += '<th>×¢×œ×•×ª ××©××‘×™×</th><th>×©×©×•×œ××•</th><th>×—×™×•×‘ ×¢×‘×•×“×”</th><th>×”× ×—×”</th>';
            h += '<th>××—×¨×™ ×”× ×—×”</th><th>×¡×”"×› ×¨×©×•××”</th>';
            h += '</tr></thead><tbody>' + rows + '</tbody></table></div>';

            // Summary cards
            h += '<div class="sec"><h2>\u{1F4CA} ×¡×™×›×•× ×›×œ×œ×™</h2><div class="sg">';
            h += '<div class="sc"><h3>\u{1F4C5} ×™××™ ×¢×‘×•×“×”</h3><div class="v">' + gv('totalDays') + '</div><div class="l">×™××™×</div></div>';
            h += '<div class="sc"><h3>\u23F0 ×©×¢×•×ª ×¢×‘×•×“×”</h3><div class="v">' + gv('totalHours') + '</div><div class="l">×©×¢×•×ª</div></div>';
            h += '<div class="sc"><h3>\u{1F4B8} ×¢×œ×•×ª ××©××‘×™×</h3><div class="v">' + gv('totalResourceCost') + '</div><div class="l">\u20AA</div></div>';
            h += '<div class="sc" style="border:2px solid #4CAF50"><h3>\u{1F4B3} ××©××‘×™× ×©×©×•×œ××•</h3><div class="v" style="color:#2e7d32">' + gv('totalPaidResources') + '</div><div class="l">\u20AA</div></div>';
            h += '<div class="sc"><h3>\u{1F4B0} ×œ×ª×©×œ×•×</h3><div class="v">' + gv('totalIncome') + '</div><div class="l">\u20AA</div></div>';
            h += '</div></div>';

            // Grand total
            h += '<div class="gt"><h2>\u{1F3C6} ×¡×™×›×•× ×›×•×œ×œ â€” ×›×œ ×”×¨×©×•××•×ª</h2><div class="gg">';
            h += '<div class="gc"><div class="gl">\u{1F4CB} ×¨×©×•××•×ª</div><div class="gv">' + entries.length + '</div></div>';
            h += '<div class="gc"><div class="gl">\u{1F4C5} ×™××™×</div><div class="gv">' + rN(sDays,0) + '</div></div>';
            h += '<div class="gc"><div class="gl">\u23F0 ×©×¢×•×ª</div><div class="gv">' + rN(sHours,0) + '</div></div>';
            h += '<div class="gc"><div class="gl">\u{1F4B0} ×—×™×•×‘ ×¢×‘×•×“×”</div><div class="gv">' + rN(sAfter) + ' \u20AA</div></div>';
            h += '<div class="gc"><div class="gl">\u2699\uFE0F ××©××‘×™×</div><div class="gv">' + rN(sRes) + ' \u20AA</div></div>';
            h += '</div><div class="gf">\u{1F48E} ×¡×”"×› ×›×œ×œ×™: ' + rN(sTotal) + ' \u20AA</div></div>';

            // Financial
            h += '<div class="fn"><h2>\u{1F4B0} ×¡×™×›×•× ×¤×™× × ×¡×™</h2><div class="fg">';
            h += '<div class="fi"><div class="fl">×¡×›×•× ×œ×—×™×•×‘ ×œ×¤×™ ×ª×¢×¨×™×£ ××¤×ª×— ×¢×¦×××™ ×¢× × ×¡×™×•×Ÿ</div><div class="fv">' + gv('grossIncome') + '</div></div>';
            h += '<div class="fi"><div class="fl">×¢×œ×•×™×•×ª ××©××‘×™×</div><div class="fv">' + gv('resourceCosts') + '</div></div>';
            h += '<div class="fi"><div class="fl">\u{1F4B5} ×¡×›×•× ×œ×—×™×•×‘ ××—×¨×™ ×”×ª×××•×ª</div><div class="fv">' + gv('netProfit') + '</div></div>';
            h += '<div class="fi"><div class="fl">×©×›×¨ ×©×¢×ª×™ ×××•×¦×¢</div><div class="fv">' + gv('avgHourlyRate') + '</div></div>';
            h += '</div></div>';

            // Investment
            h += '<div class="sec" style="margin-top:20px"><h2>\u{1F4BC} ×¡×™×›×•× ×”×©×§×¢×”</h2><div class="sg">';
            h += '<div class="sc"><h3>×”×©×§×¢×•×ª ×§×•×“××•×ª</h3><div class="v">' + gv('previousInvestments') + '</div><div class="l">\u20AA</div></div>';
            h += '<div class="sc"><h3>×ª×—×–×™×ª ×—×“×©×”</h3><div class="v">' + gv('newInvestmentForecast') + '</div><div class="l">\u20AA</div></div>';
            h += '<div class="sc" style="border:3px solid #667eea"><h3>\u{1F3AF} ×¡×”"×› ×”×©×§×¢×”</h3><div class="v" style="color:#667eea">' + gv('totalProjectInvestment') + '</div><div class="l">\u20AA</div></div>';
            h += '</div></div>';

            // Footer
            h += '</div>'; // cnt
            h += '<div class="ft">×™×•××Ÿ ×¤×¨×•×™×§×˜×™× ××ª×§×“× â€” × ×™×”×•×œ ××©××‘×™× ×•×¢×œ×•×™×•×ª | ' + dateStr + '</div>';
            h += '</div>'; // ctr
            h += '</body></html>';

            // Download with proper UTF-8
            var blob = new Blob([h], {type: 'text/html;charset=utf-8'});
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            var ts = now.getFullYear() + String(now.getMonth()+1).padStart(2,'0') + String(now.getDate()).padStart(2,'0');
            a.download = pName.replace(/\s+/g,'_') + '_×“×•×—_' + ts + '.html';
            a.click();
            URL.revokeObjectURL(url);
            alert('\u2705 ×“×•×— HTML ××§×¦×•×¢×™ × ×•×¦×¨ ×œ×”×•×¨×“×”!\n× ×™×ª×Ÿ ×œ×¤×ª×•×— ×‘×“×¤×“×¤×Ÿ ××• ×œ×©×œ×•×— ×‘××™×™×œ.');
        }

        function saveToLocalStorage() {
            localStorage.setItem('projectsData', JSON.stringify(projects));
            localStorage.setItem('projectCounter', projectCounter);
        }

        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('projectsData');
            const savedCounter = localStorage.getItem('projectCounter');
            
            if (savedData) {
                projects = JSON.parse(savedData);
                projectCounter = parseInt(savedCounter) || 1;

                // Rebuild tabs and content for all projects except 0
                const tabsContainer = document.getElementById('projectTabs');
                const addBtn = tabsContainer.querySelector('.add-project-btn');
                
                for (const [projectId, project] of Object.entries(projects)) {
                    if (projectId == 0) {
                        initializeProject(0);
                        continue;
                    }

                    // Add tab
                    const newTab = document.createElement('button');
                    newTab.className = 'tab';
                    newTab.dataset.project = projectId;
                    newTab.innerHTML = `<span class="remove-tab" onclick="removeProject(${projectId}, event)">âœ–</span>${project.name}`;
                    newTab.onclick = function() { switchProject(parseInt(projectId)); };
                    tabsContainer.insertBefore(newTab, addBtn);

                    // Create project content
                    const mainContainer = document.querySelector('.container');
                    const projectContent = document.querySelector('.project-content').cloneNode(true);
                    projectContent.id = `project-${projectId}`;
                    projectContent.className = 'project-content';
                    projectContent.innerHTML = projectContent.innerHTML.replace(/\-0/g, `-${projectId}`);
                    mainContainer.appendChild(projectContent);

                    initializeProject(parseInt(projectId));
                }
            }
        }

        // Planning Resources Functions
        function addPlanningResource(projectId) {
            const nameInput = document.getElementById(`planningResourceName-${projectId}`);
            const costInput = document.getElementById(`planningResourceCost-${projectId}`);
            
            const name = nameInput.value.trim();
            const cost = parseFloat(costInput.value);

            if (!name || isNaN(cost) || cost < 0) {
                alert('× × ×œ××œ× ×©× ××©××‘ ×•×¢×œ×•×ª ×ª×§×™× ×”');
                return;
            }

            if (!projects[projectId].planningResources) {
                projects[projectId].planningResources = {};
            }

            projects[projectId].planningResources[name] = cost;
            nameInput.value = '';
            costInput.value = '';
            
            updatePlanningResourceList(projectId);
            updatePlanningCalculations(projectId);
            saveToLocalStorage();
        }

        function updatePlanningResourceList(projectId) {
            const container = document.getElementById(`planningResourceList-${projectId}`);
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!projects[projectId].planningResources) {
                projects[projectId].planningResources = {};
            }
            
            for (const [name, cost] of Object.entries(projects[projectId].planningResources)) {
                const div = document.createElement('div');
                div.className = 'resource-item';
                div.innerHTML = `
                    <strong>${name}</strong>
                    <div>
                        <input type="number" value="${cost}" step="0.01" 
                               onchange="updatePlanningResourceCost(${projectId}, '${name}', this.value)">
                        <span> â‚ª/×™×•×</span>
                        <button onclick="removePlanningResource(${projectId}, '${name}')">ğŸ—‘ï¸</button>
                    </div>
                `;
                container.appendChild(div);
            }
        }

        function updatePlanningResourceCost(projectId, resourceName, newCost) {
            projects[projectId].planningResources[resourceName] = parseFloat(newCost);
            updatePlanningCalculations(projectId);
            saveToLocalStorage();
        }

        function removePlanningResource(projectId, resourceName) {
            if (confirm(`×”×× ×œ××—×•×§ ××ª ×”××©××‘ "${resourceName}"?`)) {
                delete projects[projectId].planningResources[resourceName];
                updatePlanningResourceList(projectId);
                updatePlanningCalculations(projectId);
                saveToLocalStorage();
            }
        }

        function updatePlanningCalculations(projectId) {
            const daysInput = document.getElementById(`plannedDays-${projectId}`);
            const hoursPerDayInput = document.getElementById(`plannedHoursPerDay-${projectId}`);
            const hourlyRateInput = document.getElementById(`plannedHourlyRate-${projectId}`);
            
            if (!daysInput || !hoursPerDayInput || !hourlyRateInput) return;

            const days = parseFloat(daysInput.value) || 0;
            const hoursPerDay = parseFloat(hoursPerDayInput.value) || 10;
            const hourlyRate = parseFloat(hourlyRateInput.value) || 0;
            
            const totalHours = days * hoursPerDay;
            
            let resourceCost = 0;
            if (projects[projectId].planningResources) {
                for (const cost of Object.values(projects[projectId].planningResources)) {
                    resourceCost += cost * days;
                }
            }
            
            const laborCost = totalHours * hourlyRate;
            const totalCost = laborCost + resourceCost;
            
            document.getElementById(`plannedTotalDays-${projectId}`).textContent = days;
            document.getElementById(`plannedTotalHours-${projectId}`).textContent = totalHours.toFixed(1);
            document.getElementById(`plannedResourceCost-${projectId}`).textContent = resourceCost.toFixed(0);
            document.getElementById(`plannedTotalCost-${projectId}`).textContent = totalCost.toFixed(0);
            
            updateInvestmentSummary(projectId);
        }

        function updateInvestmentSummary(projectId) {
            const previousAmount = parseFloat(document.getElementById(`previousReportAmount-${projectId}`)?.value) || 0;
            const plannedCostEl = document.getElementById(`plannedTotalCost-${projectId}`);
            const newInvestment = parseFloat(plannedCostEl?.textContent) || 0;
            
            const totalInvestment = previousAmount + newInvestment;
            
            const prevInvEl = document.getElementById(`previousInvestments-${projectId}`);
            const newInvEl = document.getElementById(`newInvestmentForecast-${projectId}`);
            const totalInvEl = document.getElementById(`totalProjectInvestment-${projectId}`);
            
            if (prevInvEl) prevInvEl.textContent = previousAmount.toFixed(0);
            if (newInvEl) newInvEl.textContent = newInvestment.toFixed(0);
            if (totalInvEl) totalInvEl.textContent = totalInvestment.toFixed(0);
            
            updateRevenueCalculations(projectId);
        }

        // Software Management
        function addSoftware(projectId) {
            const nameInput = document.getElementById(`softwareName-${projectId}`);
            const costInput = document.getElementById(`softwareCost-${projectId}`);
            
            const name = nameInput.value.trim();
            const cost = parseFloat(costInput.value);

            if (!name || isNaN(cost) || cost < 0) {
                alert('× × ×œ××œ× ×©× ×ª×•×›× ×” ×•×¢×œ×•×ª ×ª×§×™× ×”');
                return;
            }

            if (!projects[projectId].softwareList) {
                projects[projectId].softwareList = [];
            }

            projects[projectId].softwareList.push({ name, cost });
            nameInput.value = '';
            costInput.value = '';
            
            renderSoftwareList(projectId);
            updateMaintenanceCosts(projectId);
            saveToLocalStorage();
        }

        function renderSoftwareList(projectId) {
            const container = document.getElementById(`softwareList-${projectId}`);
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!projects[projectId].softwareList) {
                projects[projectId].softwareList = [];
            }
            
            projects[projectId].softwareList.forEach((software, index) => {
                const div = document.createElement('div');
                div.className = 'resource-item';
                div.innerHTML = `
                    <strong>${software.name}</strong>
                    <div>
                        <input type="number" value="${software.cost}" step="0.01" 
                               onchange="updateSoftwareCost(${projectId}, ${index}, this.value)">
                        <span> â‚ª/×—×•×“×©</span>
                        <button onclick="removeSoftware(${projectId}, ${index})">ğŸ—‘ï¸</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateSoftwareCost(projectId, index, newCost) {
            projects[projectId].softwareList[index].cost = parseFloat(newCost);
            updateMaintenanceCosts(projectId);
            saveToLocalStorage();
        }

        function removeSoftware(projectId, index) {
            if (confirm('×”×× ×œ××—×•×§ ×ª×•×›× ×” ×–×•?')) {
                projects[projectId].softwareList.splice(index, 1);
                renderSoftwareList(projectId);
                updateMaintenanceCosts(projectId);
                saveToLocalStorage();
            }
        }

        // Misc Costs Management
        function addMiscCost(projectId) {
            const nameInput = document.getElementById(`miscCostName-${projectId}`);
            const amountInput = document.getElementById(`miscCostAmount-${projectId}`);
            
            const name = nameInput.value.trim();
            const amount = parseFloat(amountInput.value);

            if (!name || isNaN(amount) || amount < 0) {
                alert('× × ×œ××œ× ×ª×™××•×¨ ×•×¡×›×•× ×ª×§×™×Ÿ');
                return;
            }

            if (!projects[projectId].miscCosts) {
                projects[projectId].miscCosts = [];
            }

            projects[projectId].miscCosts.push({ name, amount });
            nameInput.value = '';
            amountInput.value = '';
            
            renderMiscCosts(projectId);
            updateMaintenanceCosts(projectId);
            saveToLocalStorage();
        }

        function renderMiscCosts(projectId) {
            const container = document.getElementById(`miscCostsList-${projectId}`);
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!projects[projectId].miscCosts) {
                projects[projectId].miscCosts = [];
            }
            
            projects[projectId].miscCosts.forEach((cost, index) => {
                const div = document.createElement('div');
                div.className = 'resource-item';
                div.innerHTML = `
                    <strong>${cost.name}</strong>
                    <div>
                        <input type="number" value="${cost.amount}" step="0.01" 
                               onchange="updateMiscCost(${projectId}, ${index}, this.value)">
                        <span> â‚ª/×—×•×“×©</span>
                        <button onclick="removeMiscCost(${projectId}, ${index})">ğŸ—‘ï¸</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateMiscCost(projectId, index, newAmount) {
            projects[projectId].miscCosts[index].amount = parseFloat(newAmount);
            updateMaintenanceCosts(projectId);
            saveToLocalStorage();
        }

        function removeMiscCost(projectId, index) {
            if (confirm('×”×× ×œ××—×•×§ ×¢×œ×•×ª ×–×•?')) {
                projects[projectId].miscCosts.splice(index, 1);
                renderMiscCosts(projectId);
                updateMaintenanceCosts(projectId);
                saveToLocalStorage();
            }
        }

        // Token Cost Calculator Functions
        function calculateTokenCosts(projectId) {
            const tokensPerSearch = parseFloat(document.getElementById(`tokensPerSearch-${projectId}`)?.value) || 5000;
            const tokenPricePer1k = parseFloat(document.getElementById(`tokenPricePer1k-${projectId}`)?.value) || 0.003;
            const usdToIls = parseFloat(document.getElementById(`usdToIls-${projectId}`)?.value) || 3.7;
            const numTherapists = parseFloat(document.getElementById(`numTherapists-${projectId}`)?.value) || 0;
            const treatmentsPerDay = parseFloat(document.getElementById(`treatmentsPerDay-${projectId}`)?.value) || 0;
            const tokensPerTreatment = parseFloat(document.getElementById(`tokensPerTreatment-${projectId}`)?.value) || 10000;
            const dailySearches = parseFloat(document.getElementById(`dailySearches-${projectId}`)?.value) || 0;
            const monthlyWorkDays = parseFloat(document.getElementById(`monthlyWorkDays-${projectId}`)?.value) || 22;

            // Calculate cost per treatment
            const costPerTreatmentUsd = (tokensPerTreatment / 1000) * tokenPricePer1k;
            const costPerTreatmentIls = costPerTreatmentUsd * usdToIls;

            // Calculate cost per search
            const costPerSearchUsd = (tokensPerSearch / 1000) * tokenPricePer1k;
            const costPerSearchIls = costPerSearchUsd * usdToIls;

            // Daily calculations
            const dailyTreatments = numTherapists * treatmentsPerDay;
            const dailyTreatmentTokens = dailyTreatments * tokensPerTreatment;
            const dailySearchTokens = dailySearches * tokensPerSearch;
            const dailyTotalTokens = dailyTreatmentTokens + dailySearchTokens;
            
            const dailyTokenCost = (dailyTreatments * costPerTreatmentIls) + (dailySearches * costPerSearchIls);

            // Monthly calculations
            const monthlyTokenCost = dailyTokenCost * monthlyWorkDays;

            // Update display
            document.getElementById(`costPerTreatment-${projectId}`).textContent = costPerTreatmentIls.toFixed(4);
            document.getElementById(`costPerSearch-${projectId}`).textContent = costPerSearchIls.toFixed(4);
            document.getElementById(`dailyTotalTokens-${projectId}`).textContent = dailyTotalTokens.toLocaleString();
            document.getElementById(`dailyTokenCost-${projectId}`).textContent = dailyTokenCost.toFixed(0);
            document.getElementById(`monthlyTokenCost-${projectId}`).textContent = monthlyTokenCost.toFixed(0);

            // Update the token cost input in maintenance section
            const tokenCostInput = document.getElementById(`tokenCost-${projectId}`);
            if (tokenCostInput) {
                tokenCostInput.value = monthlyTokenCost.toFixed(0);
            }

            // Update ROI input
            const avgTokenCostInput = document.getElementById(`avgTokenCostInput-${projectId}`);
            if (avgTokenCostInput) {
                avgTokenCostInput.value = monthlyTokenCost.toFixed(0);
            }

            calculateTokenRecommendation(projectId);
            calculateClientROI(projectId);
            updateMaintenanceCosts(projectId);
        }

        // === Export for NotebookLM (Markdown format) ===
        function exportForNotebookLM(projectId) {
            const projectName = projects[projectId].name || 'project';
            const now = new Date();
            const timestamp = now.getFullYear() + '' +
                String(now.getMonth() + 1).padStart(2, '0') +
                String(now.getDate()).padStart(2, '0') + '_' +
                String(now.getHours()).padStart(2, '0') +
                String(now.getMinutes()).padStart(2, '0');

            // --- Build Markdown content ---
            let md = `# ×™×•××Ÿ ×¤×¨×•×™×§×˜: ${projectName}\n`;
            md += `> ×™×•×¦× ×‘×ª××¨×™×š: ${now.toLocaleString('he-IL')}\n\n`;

            // --- Data Table ---
            md += `## ğŸ“‹ ×˜×‘×œ×ª × ×ª×•× ×™×\n\n`;
            const entries = projects[projectId].entries || [];
            if (entries.length === 0) {
                md += `××™×Ÿ ×¨×©×•××•×ª ×¢×“×™×™×Ÿ.\n\n`;
            } else {
                md += `| # | × ×•×¡×£ | ×ª××¨×™×š ×”×ª×—×œ×” | ×ª××¨×™×š ×¡×™×•× | ×™××™× | ×©×¢×•×ª | × ×•×©× | ××¨×›×™×‘ | ××©××‘×™× | ×”×¢×¨×•×ª | ×¢×œ×•×ª ××©××‘×™× | ×©×©×•×œ××• | ×—×™×•×‘ ×¢×‘×•×“×” | ×”× ×—×” | ××—×¨×™ ×”× ×—×” | ×¡×”"×› ×¨×©×•××” |\n`;
                md += `|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n`;
                let mdDays=0, mdHours=0, mdRes=0, mdGross=0, mdAfter=0, mdTotal=0;
                const mdPaid = projects[projectId].paidResourcesTotal || 0;
                entries.forEach((e, i) => {
                    const dp = e.discountPct || 0;
                    const cad = e.chargeAfterDiscount !== undefined ? e.chargeAfterDiscount : e.grossCharge;
                    const tot = cad + e.resourceCost;
                    mdDays += e.workDays; mdHours += e.totalHours;
                    mdRes += e.resourceCost; mdGross += e.grossCharge;
                    mdAfter += cad; mdTotal += tot;
                    md += `| ${i+1} | ${e.dateAdded || '-'} | ${e.startDate} | ${e.endDate} | ${e.workDays} | ${e.totalHours} | ${e.topic} | ${e.component} | ${(e.resources||[]).join(', ')} | ${e.notes || '-'} | ${e.resourceCost.toFixed(0)} | ${i === 0 && mdPaid > 0 ? mdPaid.toFixed(0) : '-'} | ${e.grossCharge.toFixed(0)} | ${dp > 0 ? dp+'%' : '-'} | ${cad.toFixed(0)} | **${tot.toFixed(0)}** |\n`;
                });
                const mdNetTotal = mdTotal - mdPaid;
                md += `| | | | **×¡×”"×›** | **${mdDays}** | **${mdHours}** | | | | | **${mdRes.toFixed(0)}** | **${mdPaid.toFixed(0)}** | **${mdGross.toFixed(0)}** | | **${mdAfter.toFixed(0)}** | **${mdNetTotal.toFixed(0)}** |\n`;
                md += `\n`;
            }

            // --- Summary cards ---
            md += `## ğŸ“Š ×¡×™×›×•× ×›×œ×œ×™\n\n`;
            const getVal = (id) => document.getElementById(`${id}-${projectId}`)?.textContent || '0';
            md += `- **×¡×”"×› ×™××™ ×¢×‘×•×“×”:** ${getVal('totalDays')} ×™××™×\n`;
            md += `- **×¡×”"×› ×©×¢×•×ª ×¢×‘×•×“×”:** ${getVal('totalHours')} ×©×¢×•×ª\n`;
            md += `- **×¡×”"×› ×¢×œ×•×ª ××©××‘×™×:** ${getVal('totalResourceCost')} â‚ª\n`;
            md += `- **×¡×”"×› ××©××‘×™× ×©×©×•×œ××•:** ${getVal('totalPaidResources')} â‚ª\n`;
            md += `- **×¡×”"×› ×œ×ª×©×œ×•×:** ${getVal('totalIncome')} â‚ª\n`;
            md += `- **×¡×”"×› ×›×œ×œ×™:** ${getVal('gtGrandTotal')} â‚ª\n\n`;

            // --- Token costs ---
            md += `## ğŸ¤– ×¢×œ×•×™×•×ª ×˜×•×§× ×™×\n\n`;
            md += `- **×¢×œ×•×ª ×˜×•×§× ×™× ×œ×˜×™×¤×•×œ:** ${getVal('costPerTreatment')} â‚ª\n`;
            md += `- **×¢×œ×•×ª ×˜×•×§× ×™× ×œ×—×™×¤×•×©:** ${getVal('costPerSearch')} â‚ª\n`;
            md += `- **×¡×”"×› ×˜×•×§× ×™× ×™×•××™×™×:** ${getVal('dailyTotalTokens')}\n`;
            md += `- **×¢×œ×•×ª ×™×•××™×ª ×›×•×œ×œ×ª:** ${getVal('dailyTokenCost')} â‚ª\n`;
            md += `- **×¢×œ×•×ª ×—×•×“×©×™×ª ×˜×•×§× ×™×:** ${getVal('monthlyTokenCost')} â‚ª\n\n`;

            // --- Maintenance costs ---
            md += `## ğŸ”§ ×¢×œ×•×™×•×ª ×ª×—×–×•×§×” ×—×•×“×©×™×•×ª\n\n`;
            const getInput = (id) => document.getElementById(`${id}-${projectId}`)?.value || '0';
            md += `- **××—×¡×•×Ÿ ×”××ª×¨:** ${getInput('hostingCost')} â‚ª\n`;
            md += `- **×¢×œ×•×ª ×˜×•×§× ×™×:** ${getInput('tokenCost')} â‚ª\n`;
            md += `- **×©×¢×•×ª ×ª×—×–×•×§×”:** ${getInput('maintenanceHours')} ×©×¢×•×ª Ã— ${getInput('programmerRate')} â‚ª/×©×¢×”\n`;
            md += `- **×¢××œ×•×ª ×’×‘×™×™×”:** ${getInput('paymentFees')} â‚ª\n`;
            md += `- **×”×•×¦××•×ª ×©×•× ×•×ª:** ${getInput('otherFixedCosts')} â‚ª\n`;

            // Software list
            if (projects[projectId].softwareList && projects[projectId].softwareList.length > 0) {
                md += `- **×ª×•×›× ×•×ª:**\n`;
                projects[projectId].softwareList.forEach(s => {
                    md += `  - ${s.name}: ${s.cost} â‚ª/×—×•×“×©\n`;
                });
            }
            // Misc costs
            if (projects[projectId].miscCosts && projects[projectId].miscCosts.length > 0) {
                md += `- **×¢×œ×•×™×•×ª × ×•×¡×¤×•×ª:**\n`;
                projects[projectId].miscCosts.forEach(c => {
                    md += `  - ${c.name}: ${c.amount} â‚ª\n`;
                });
            }
            md += `- **×¡×”"×› ×¢×œ×•×™×•×ª ×ª×—×–×•×§×”:** ${getVal('totalMonthlyCosts')} â‚ª/×—×•×“×©\n\n`;

            // --- Revenue ---
            md += `## ğŸ“ˆ ×”×›× ×¡×•×ª ×•×¨×•×•×—×™×•×ª\n\n`;
            md += `- **×”×›× ×¡×” ×—×•×“×©×™×ª ×¦×¤×•×™×”:** ${getVal('totalMonthlyRevenue')} â‚ª\n`;
            md += `- **×”×›× ×¡×•×ª ×—×•×“×©×™×•×ª:** ${getVal('finalMonthlyRevenue')}\n`;
            md += `- **×”×•×¦××•×ª ×ª×—×–×•×§×”:** ${getVal('finalMonthlyCosts')}\n`;
            md += `- **×¨×•×•×—/×”×¤×¡×“ ×—×•×“×©×™:** ${getVal('monthlyProfitLoss')}\n`;
            md += `- **×–××Ÿ ×”×—×–×¨ ×”×©×§×¢×”:** ${getVal('roiMonths')}\n`;
            md += `- **××™× ×™××•× ×× ×•×™×™× ×œ×¨×•×•×—:** ${getVal('minSubscribersRecommendation')}\n\n`;

            // --- Investment summary ---
            md += `## ğŸ’¼ ×¡×™×›×•× ×”×©×§×¢×”\n\n`;
            md += `- **×”×©×§×¢×•×ª ×§×•×“××•×ª:** ${getVal('previousInvestments')} â‚ª\n`;
            md += `- **×ª×—×–×™×ª ×”×©×§×¢×” ×—×“×©×”:** ${getVal('newInvestmentForecast')} â‚ª\n`;
            md += `- **×¡×”"×› ×”×©×§×¢×” ×›×•×œ×œ×ª:** ${getVal('totalProjectInvestment')} â‚ª\n\n`;

            // --- Financial summary ---
            md += `## ğŸ’° ×¡×™×›×•× ×¤×™× × ×¡×™\n\n`;
            md += `- **×¡×›×•× ×œ×—×™×•×‘ ×œ×¤×™ ×ª×¢×¨×™×£ ××¤×ª×— ×¢×¦×××™ ×¢× × ×¡×™×•×Ÿ:** ${getVal('grossIncome')}\n`;
            md += `- **×¢×œ×•×™×•×ª ××©××‘×™×:** ${getVal('resourceCosts')}\n`;
            md += `- **×¡×›×•× ×œ×—×™×•×‘ ××—×¨×™ ×”×ª×××•×ª:** ${getVal('netProfit')}\n`;
            md += `- **×©×›×¨ ×©×¢×ª×™ ×××•×¦×¢ × ×˜×•:** ${getVal('avgHourlyRate')}\n`;
            md += `- **×™×ª×¨×” ×œ×ª×©×œ×•×:** ${getVal('balanceDue')}\n\n`;

            // --- Grand Total ---
            md += `## ğŸ† ×¡×™×›×•× ×›×•×œ×œ\n\n`;
            md += `| × ×ª×•×Ÿ | ×¢×¨×š |\n|---|---|\n`;
            md += `| ×¨×©×•××•×ª | ${entries.length} |\n`;
            md += `| ×™××™ ×¢×‘×•×“×” | ${getVal('gtDays')} |\n`;
            md += `| ×©×¢×•×ª | ${getVal('gtHours')} |\n`;
            md += `| ×—×™×•×‘ ×¢×‘×•×“×” | ${getVal('gtWorkCharge')} |\n`;
            md += `| ×¢×œ×•×ª ××©××‘×™× | ${getVal('gtResourceCost')} |\n`;
            md += `| **ğŸ’ ×¡×”"×› ×›×œ×œ×™** | **${getVal('gtGrandTotal')} â‚ª** |\n\n`;

            md += `---\n*× ×•×¦×¨ ××•×˜×•××˜×™×ª ××™×•××Ÿ ×¤×¨×•×™×§×˜×™× ××ª×§×“×*\n`;

            // --- Download as .md ---
            const safeName = projectName.replace(/\s+/g, '_');
            const fileName = `NotebookLM_${safeName}_${timestamp}.md`;

            const blob = new Blob([md], { type: 'text/markdown;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);

            // --- Also copy to clipboard ---
            navigator.clipboard.writeText(md).then(() => {
                alert(`âœ… ×§×•×‘×¥ Markdown × ×•×¦×¨: ${fileName}\n\nğŸ“‹ ×”×˜×§×¡×˜ ×’× ×”×•×¢×ª×§ ×œ×œ×•×—!\n\n××¤×©×¨×•×™×•×ª ×”×¢×œ××” ×œ-NotebookLM:\n1. ×”×¢×œ×” ××ª ×§×•×‘×¥ ×”-.md ×™×©×™×¨×•×ª\n2. ××•: ×‘-NotebookLM ×œ×—×¥ "Copied text" ×•×”×“×‘×§`);
            }).catch(() => {
                alert(`âœ… ×§×•×‘×¥ Markdown × ×•×¦×¨: ${fileName}\n\n×”×¢×œ×” ××ª ×”×§×•×‘×¥ ×œ-NotebookLM ×›-source.`);
            });
        }

        // === Report History Functions ===
        function addReportToHistory(filename) {
            const now = new Date();
            const dateStr = now.toLocaleString('he-IL');
            savedReports.push({ filename, date: dateStr, timestamp: now.getTime() });
            localStorage.setItem('savedReports', JSON.stringify(savedReports));
            renderReportHistory();
        }

        function renderReportHistory() {
            const tbody = document.getElementById('reportHistoryBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            if (savedReports.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="3" style="text-align:center;color:#999;">××™×Ÿ ×“×•×—×•×ª ×©× ×©××¨×• ×¢×“×™×™×Ÿ</td>';
                return;
            }

            const sorted = [...savedReports].reverse();
            sorted.forEach((report, idx) => {
                const realIdx = savedReports.length - 1 - idx;
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${report.filename}</td>
                    <td>${report.date}</td>
                    <td><button class="delete-btn" onclick="removeReportFromHistory(${realIdx})">ğŸ—‘ï¸ ××—×§</button></td>
                `;
            });
        }

        function removeReportFromHistory(index) {
            if (confirm('×”×× ×œ××—×•×§ ×¨×©×•××” ×–×• ××”×”×™×¡×˜×•×¨×™×”?')) {
                savedReports.splice(index, 1);
                localStorage.setItem('savedReports', JSON.stringify(savedReports));
                renderReportHistory();
            }
        }

        function loadReportFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(ev) {
                    try {
                        const data = JSON.parse(ev.target.result);
                        if (data.name && data.entries) {
                            projects[0] = data;
                        } else {
                            for (const key in data) {
                                projects[key] = data[key];
                            }
                        }
                        saveToLocalStorage();
                        alert('×”×“×•×— × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”! ×”×“×£ ×™×˜×¢×Ÿ ××—×“×©...');
                        location.reload();
                    } catch (err) {
                        alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×§×•×‘×¥: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function calculateTokenRecommendation(projectId) {
            const subscriptionPriceUsd = parseFloat(document.getElementById(`subscriptionPriceUsd-${projectId}`)?.value) || 8;
            const usdToIls = parseFloat(document.getElementById(`usdToIls-${projectId}`)?.value) || 3.7;
            const tokenPricePer1k = parseFloat(document.getElementById(`tokenPricePer1k-${projectId}`)?.value) || 0.003;
            const tokensPerTreatment = parseFloat(document.getElementById(`tokensPerTreatment-${projectId}`)?.value) || 10000;
            const monthlyWorkDays = parseFloat(document.getElementById(`monthlyWorkDays-${projectId}`)?.value) || 22;

            const subscriptionPriceIls = subscriptionPriceUsd * usdToIls;
            
            // Target: 30% profit margin minimum
            const targetCostRatio = 0.7; // 70% of revenue can go to costs
            const maxTokenCostPerSubscriber = subscriptionPriceIls * targetCostRatio;
            
            // Calculate how many tokens this budget allows
            const tokenCostPer1kIls = tokenPricePer1k * usdToIls;
            const recommendedMonthlyTokens = Math.floor((maxTokenCostPerSubscriber / tokenCostPer1kIls) * 1000);
            
            // Calculate how many treatments this allows
            const recommendedTreatments = Math.floor(recommendedMonthlyTokens / tokensPerTreatment);
            
            // Calculate actual profit
            const actualTokenCost = (recommendedMonthlyTokens / 1000) * tokenCostPer1kIls;
            const profitPerSubscriber = subscriptionPriceIls - actualTokenCost;
            const profitMargin = ((profitPerSubscriber / subscriptionPriceIls) * 100);

            // Update display
            document.getElementById(`recommendedMonthlyTokens-${projectId}`).textContent = recommendedMonthlyTokens.toLocaleString();
            document.getElementById(`recommendedTreatments-${projectId}`).textContent = recommendedTreatments;
            document.getElementById(`profitPerSubscriber-${projectId}`).textContent = profitPerSubscriber.toFixed(0);
            document.getElementById(`profitMargin-${projectId}`).textContent = profitMargin.toFixed(1) + '%';

            // Generate AI recommendation text
            const treatmentsPerDay = Math.ceil(recommendedTreatments / monthlyWorkDays);
            let recommendation = `ğŸ’¡ <strong>×”××œ×¦×”:</strong><br>`;
            recommendation += `×‘××—×™×¨ ×× ×•×™ ×©×œ $${subscriptionPriceUsd} (${subscriptionPriceIls.toFixed(0)} â‚ª), ××•××œ×¥ ×œ×”×’×‘×™×œ ×›×œ ××˜×¤×œ ×œ-<strong>${recommendedMonthlyTokens.toLocaleString()} ×˜×•×§× ×™× ×œ×—×•×“×©</strong>.<br>`;
            recommendation += `×–×” ×××¤×©×¨ ×›-<strong>${recommendedTreatments} ×˜×™×¤×•×œ×™× ×œ×—×•×“×©</strong> (×›-${treatmentsPerDay} ×˜×™×¤×•×œ×™× ×œ×™×•× ×¢×‘×•×“×”).<br>`;
            recommendation += `×¨×•×•×— × ×˜×•: <strong>${profitPerSubscriber.toFixed(0)} â‚ª</strong> ×œ××˜×¤×œ (${profitMargin.toFixed(1)}% ×¨×•×•×—×™×•×ª).`;
            
            if (profitMargin < 20) {
                recommendation += `<br>âš ï¸ <strong>××–×”×¨×”:</strong> ×©×•×œ×™ ×¨×•×•×— × ××•×›×™× - ×©×§×•×œ ×œ×”×¢×œ×•×ª ××—×™×¨ ××• ×œ×”×¤×—×™×ª ×˜×•×§× ×™×.`;
            } else if (profitMargin > 50) {
                recommendation += `<br>âœ… <strong>××¦×•×™×Ÿ!</strong> ×©×•×œ×™ ×¨×•×•×— ×’×‘×•×”×™× - ×™×© ××§×•× ×œ×”×’×“×™×œ ×›××•×ª ×˜×•×§× ×™× ××• ×œ×”×•×¨×™×“ ××—×™×¨.`;
            }

            document.getElementById(`aiRecommendation-${projectId}`).innerHTML = recommendation;
        }

        function calculateClientROI(projectId) {
            const fixedCosts = parseFloat(document.getElementById(`fixedMonthlyCosts-${projectId}`)?.value) || 0;
            const tokenCosts = parseFloat(document.getElementById(`avgTokenCostInput-${projectId}`)?.value) || 0;
            const subscribers = parseFloat(document.getElementById(`estimatedSubscribers-${projectId}`)?.value) || 0;
            const revenue = parseFloat(document.getElementById(`monthlySubscriptionRevenue-${projectId}`)?.value) || 0;

            const totalCosts = fixedCosts + tokenCosts;
            const netProfit = revenue - totalCosts;

            document.getElementById(`roiTotalRevenue-${projectId}`).textContent = revenue.toFixed(0) + ' â‚ª';
            document.getElementById(`roiFixedCosts-${projectId}`).textContent = fixedCosts.toFixed(0) + ' â‚ª';
            document.getElementById(`roiTokenCosts-${projectId}`).textContent = tokenCosts.toFixed(0) + ' â‚ª';
            document.getElementById(`roiNetProfit-${projectId}`).textContent = netProfit.toFixed(0) + ' â‚ª';

            // Calculate payback period
            const totalInvestmentEl = document.getElementById(`totalProjectInvestment-${projectId}`);
            const totalInvestment = parseFloat(totalInvestmentEl?.textContent) || 0;

            const paybackMonthsEl = document.getElementById(`roiPaybackMonths-${projectId}`);
            if (netProfit > 0 && totalInvestment > 0) {
                const months = Math.ceil(totalInvestment / netProfit);
                paybackMonthsEl.textContent = months + ' ×—×•×“×©×™×';
            } else {
                paybackMonthsEl.textContent = '- ×—×•×“×©×™×';
            }
        }

        function updateMaintenanceCosts(projectId) {
            const hostingCost = parseFloat(document.getElementById(`hostingCost-${projectId}`)?.value) || 0;
            const tokenCost = parseFloat(document.getElementById(`tokenCost-${projectId}`)?.value) || 0;
            const maintenanceHours = parseFloat(document.getElementById(`maintenanceHours-${projectId}`)?.value) || 0;
            const programmerRate = parseFloat(document.getElementById(`programmerRate-${projectId}`)?.value) || 0;
            const paymentFees = parseFloat(document.getElementById(`paymentFees-${projectId}`)?.value) || 0;
            const otherFixedCosts = parseFloat(document.getElementById(`otherFixedCosts-${projectId}`)?.value) || 0;
            
            let softwareCosts = 0;
            if (projects[projectId].softwareList) {
                projects[projectId].softwareList.forEach(software => {
                    softwareCosts += software.cost;
                });
            }
            
            let miscCostsTotal = 0;
            if (projects[projectId].miscCosts) {
                projects[projectId].miscCosts.forEach(cost => {
                    miscCostsTotal += cost.amount;
                });
            }
            
            const maintenanceLaborCost = maintenanceHours * programmerRate;
            const totalMonthlyCosts = hostingCost + tokenCost + maintenanceLaborCost + paymentFees + softwareCosts + miscCostsTotal + otherFixedCosts;
            
            const totalCostEl = document.getElementById(`totalMonthlyCosts-${projectId}`);
            if (totalCostEl) {
                totalCostEl.textContent = totalMonthlyCosts.toFixed(0);
            }
            
            updateRevenueCalculations(projectId);
        }

        function updateRevenueCalculations(projectId) {
            const subscribers = parseFloat(document.getElementById(`monthlySubscribers-${projectId}`)?.value) || 0;
            const subscriptionPrice = parseFloat(document.getElementById(`subscriptionPrice-${projectId}`)?.value) || 0;
            const additionalRevenue = parseFloat(document.getElementById(`additionalRevenue-${projectId}`)?.value) || 0;
            
            const totalRevenue = (subscribers * subscriptionPrice) + additionalRevenue;
            
            const totalRevenueEl = document.getElementById(`totalMonthlyRevenue-${projectId}`);
            if (totalRevenueEl) {
                totalRevenueEl.textContent = totalRevenue.toFixed(0);
            }
            
            // Final profit/loss calculations
            const totalCostEl = document.getElementById(`totalMonthlyCosts-${projectId}`);
            const totalCosts = parseFloat(totalCostEl?.textContent) || 0;
            
            const profitLoss = totalRevenue - totalCosts;
            
            const finalRevenueEl = document.getElementById(`finalMonthlyRevenue-${projectId}`);
            const finalCostsEl = document.getElementById(`finalMonthlyCosts-${projectId}`);
            const profitLossEl = document.getElementById(`monthlyProfitLoss-${projectId}`);
            const profitLossLabel = document.getElementById(`profitLossLabel-${projectId}`);
            
            if (finalRevenueEl) finalRevenueEl.textContent = totalRevenue.toFixed(0) + ' â‚ª';
            if (finalCostsEl) finalCostsEl.textContent = totalCosts.toFixed(0) + ' â‚ª';
            if (profitLossEl) {
                profitLossEl.textContent = profitLoss.toFixed(0) + ' â‚ª';
                profitLossEl.style.color = profitLoss >= 0 ? '#4CAF50' : '#ff4444';
            }
            if (profitLossLabel) {
                profitLossLabel.textContent = profitLoss >= 0 ? 'ğŸ’µ ×¨×•×•×— ×—×•×“×©×™' : 'âš ï¸ ×”×¤×¡×“ ×—×•×“×©×™';
            }
            
            // ROI calculation
            const totalInvestmentEl = document.getElementById(`totalProjectInvestment-${projectId}`);
            const totalInvestment = parseFloat(totalInvestmentEl?.textContent) || 0;
            
            const roiMonthsEl = document.getElementById(`roiMonths-${projectId}`);
            if (roiMonthsEl && profitLoss > 0) {
                const months = Math.ceil(totalInvestment / profitLoss);
                roiMonthsEl.textContent = months + ' ×—×•×“×©×™×';
            } else if (roiMonthsEl) {
                roiMonthsEl.textContent = '- ×—×•×“×©×™×';
            }
            
            // Minimum subscribers recommendation
            const minSubscribersEl = document.getElementById(`minSubscribersRecommendation-${projectId}`);
            if (minSubscribersEl && subscriptionPrice > 0) {
                const minSubscribers = Math.ceil(totalCosts / subscriptionPrice);
                minSubscribersEl.textContent = minSubscribers;
            } else if (minSubscribersEl) {
                minSubscribersEl.textContent = '0';
            }
        }
    </script>
</body>
</html>

